<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HydReq GUI</title>
  <!-- DaisyUI (includes Tailwind CSS precompiled) for better components/spacing -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daisyui@4.12.10/dist/full.min.css">
  <!-- CodeMirror for YAML editing -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/material-darker.min.css">
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/yaml/yaml.min.js"></script>
  <!-- js-yaml for client-side YAML serialization/parsing -->
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    /* Compact fields: narrow numeric inputs */
    #ed_stage, #ed_timeout, #ed_assert_status, #ed_assert_maxDuration,
    #ed_retry_max, #ed_retry_backoff, #ed_retry_jitter { max-width: 160px; }
    /* Align checkboxes toward the left edge of their column */
    #ed_skip, #ed_only, #ed_retry_enable { margin-left: 0; justify-self: start; }
    /* Densify grids and sections */
    #ed_suite_form, #ed_req_form, #ed_assert_form, #ed_flow_form, #ed_retry_form, #ed_oapi_form { gap: 6px !important; }
    #pane_visual details > summary { padding: 6px !important; }
    #pane_visual details > div { padding: 6px !important; }
    #ed_preview { gap: 6px !important; }
    /* Editor compact sizing for numeric fields */
    #ed_stage, #ed_timeout, #ed_assert_status, #ed_assert_maxDuration,
    #ed_retry_max, #ed_retry_backoff, #ed_retry_jitter {
      max-width: 160px;
    }
    /* Align checkboxes to the left (no extra offset) */
    #ed_skip, #ed_only, #ed_retry_enable { margin-left: 0; }
    /* Modal scroll containment and compact sizing */
    #editorModal { overscroll-behavior: contain; }
    body.modal-open { overflow: hidden; }
    #editorModal .editor-root { font-size: 14px; }
    /* Runner area: slightly smaller fonts for denser output */
    #results, .run { font-size: 12px; }
    #suites li { font-size: 13px; }
    /* Anti-vertical-squish safety: allow flex children to shrink and scroll */
    .flex-col { display:flex; flex-direction:column; min-height:0; }
    .scroll { overflow:auto; min-height:0; }
    /* Theme tokens */
    :root {
      --hdr-bg:#0b1020; --hdr-fg:#c6e2ff; --bd:#e5e7eb; --li-hov:#f5f7fb; --li-sel:#e6f2ff; --pill:#eef2ff; --pg-bg:#eee; --txt:#111827; --bg:#ffffff;
      --btn-bg:#ffffff; --btn-bd:#d1d5db; --btn-hov:#f6f9ff; --link:#2563eb;
      --input-bg:#ffffff; --input-bd:#d1d5db; --input-fg:#111827; --input-focus:#7aa2ff;
      --success:#10b981; --error:#ef4444; --warning:#f59e0b; --info:#3b82f6;
      --grad1:#00d4ff; --grad2:#5bff5b;
    }
    body.dark {
      --hdr-bg:#0b0e17; --hdr-fg:#d6e0ff; --bd:#222; --li-hov:#1a2230; --li-sel:#10213a; --pill:#1f2937; --pg-bg:#1f2937; --txt:#e5e7eb; --bg:#0b0e17;
      --btn-bg:#111827; --btn-bd:#374151; --btn-hov:#1f2937; --link:#60a5fa;
      --input-bg:#0f172a; --input-bd:#374151; --input-fg:#e5e7eb; --input-focus:#7aa2ff;
      --success:#10b981; --error:#ef4444; --warning:#f59e0b; --info:#60a5fa;
      --grad1:#22d3ee; --grad2:#4ade80;
    }
  /* Hack theme: neon terminal vibe */
    body.hack {
      --hdr-bg:#061108; --hdr-fg:#a6ffb0; --bd:#15331b; --li-hov:#0b1f10; --li-sel:#0f2a16; --pill:#092010; --pg-bg:#0f2a16; --txt:#c8ffd2; --bg:#050d07;
      --btn-bg:#0a1a0f; --btn-bd:#1a3b24; --btn-hov:#0e2315; --link:#8affb5;
      --input-bg:#0b1f10; --input-bd:#1a3b24; --input-fg:#c8ffd2; --input-focus:#30ff7f;
      --success:#30ff7f; --error:#ff5f5f; --warning:#ffd166; --info:#7dd3fc;
      --grad1:#19ff93; --grad2:#5bff5b;
    }
  /* Catppuccin Mocha (dark) */
    body.catppuccin-mocha {
      --hdr-bg:#11111b; --hdr-fg:#cdd6f4; --bd:#313244; --li-hov:#1e1e2e; --li-sel:#181825; --pill:#181825; --pg-bg:#181825; --txt:#cdd6f4; --bg:#0b0b13;
      --btn-bg:#11111b; --btn-bd:#313244; --btn-hov:#1e1e2e; --link:#89b4fa;
      --input-bg:#1e1e2e; --input-bd:#313244; --input-fg:#cdd6f4; --input-focus:#89b4fa;
      --success:#a6e3a1; --error:#f38ba8; --warning:#f9e2af; --info:#89b4fa;
      --grad1:#89b4fa; --grad2:#a6e3a1;
    }
  /* Catppuccin Latte (light) */
    body.catppuccin-latte {
      --hdr-bg:#eff1f5; --hdr-fg:#4c4f69; --bd:#bcc0cc; --li-hov:#e6e9ef; --li-sel:#dce0e8; --pill:#e6e9ef; --pg-bg:#e6e9ef; --txt:#4c4f69; --bg:#fafafa;
      --btn-bg:#ffffff; --btn-bd:#ccd0da; --btn-hov:#e6e9ef; --link:#1e66f5;
      --input-bg:#ffffff; --input-bd:#ccd0da; --input-fg:#4c4f69; --input-focus:#1e66f5;
      --success:#40a02b; --error:#d20f39; --warning:#df8e1d; --info:#1e66f5;
      --grad1:#1e66f5; --grad2:#40a02b;
    }
    /* Synthwave (dark, DaisyUI-inspired) */
    body.synthwave {
      --hdr-bg:#2d1b69; --hdr-fg:#f5f1ff; --bd:#3d2a7a; --li-hov:#332366; --li-sel:#3c2b78; --pill:#2f205f; --pg-bg:#2f205f; --txt:#f8f8ff; --bg:#231638;
      --btn-bg:#2a1f57; --btn-bd:#4a3a8f; --btn-hov:#33276b; --link:#58c7f3;
      --input-bg:#1f163f; --input-bd:#4a3a8f; --input-fg:#f5f1ff; --input-focus:#58c7f3;
      --success:#36d399; --error:#f87272; --warning:#fbbd23; --info:#58c7f3;
      --grad1:#f472b6; --grad2:#60a5fa;
    }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; margin: 0; background: var(--bg); color: var(--txt); }
    header { background: var(--hdr-bg); color: var(--hdr-fg); padding: 16px; font-weight: 700; display:flex; align-items:center; justify-content:space-between; }
    /* Make the left pane slightly wider for better file names and controls */
    main { display: grid; grid-template-columns: 520px 1fr; height: calc(100vh - 64px); }
    aside { border-right: 1px solid var(--bd); padding: 12px; overflow: auto; }
    section { padding: 12px; overflow: auto; }
    ul { list-style: none; padding: 0; margin: 0; }
    li { padding: 6px 8px; border-radius: 6px; cursor: pointer; }
  li:hover { background: var(--li-hov); }
  li.selected { background: var(--li-sel); }
    .row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
  .pill { background: var(--pill); border-radius: 999px; padding: 2px 8px; font-size: 12px; }
  .progress { height: 10px; background: var(--pg-bg); border-radius: 6px; overflow: hidden; }
  .progress > div { height: 10px; background: linear-gradient(90deg, var(--grad1), var(--grad2)); width: 0%; }
    .log { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; white-space: pre-wrap; }
  .ok { color: var(--success); } .fail { color: var(--error); } .skip { color: var(--warning); }
    /* Runner area: slightly smaller fonts for denser output */
    #results, .run { font-size: 12px; }
    .toolbar { display:flex; gap:8px; align-items:center; }
  button { padding: 6px 10px; border: 1px solid var(--btn-bd); background: var(--btn-bg); border-radius: 6px; cursor: pointer; color: inherit; }
    button:hover { background: var(--btn-hov); }
    .run { color:#3b82f6 }
    /* Ensure the embedded code editor fills its pane */
    .CodeMirror { height: 100%; width: 100%; border: 1px solid var(--bd); border-radius: 6px; }
    body.dark .CodeMirror { background: #0f172a; color: #e5e7eb; }
    /* Inputs/selects themed via variables */
    #editorModal input[type="text"],
    #editorModal input[type="number"],
    #editorModal select,
    #editorModal textarea {
      background: var(--input-bg);
      border: 1px solid var(--input-bd);
      color: var(--input-fg);
    }
    #editorModal input[type="text"]:focus,
    #editorModal input[type="number"]:focus,
    #editorModal select:focus,
    #editorModal textarea:focus {
      outline: 2px solid var(--input-focus);
      outline-offset: 1px;
      border-color: var(--input-focus);
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--input-focus) 25%, transparent);
      background: var(--input-bg);
    }
    a { color: var(--link); }
    /* Splitter visual feedback */
    #ed_splitter:hover { background: #93c5fd !important; }
    #ed_splitter.dragging { background: #60a5fa !important; }
    /* Density overrides when comfortable is selected */
    #editorModal .editor-root.comfortable { font-size: 15px; }
    #editorModal .editor-root.comfortable input[type="text"],
    #editorModal .editor-root.comfortable input[type="number"],
    #editorModal .editor-root.comfortable select,
    #editorModal .editor-root.comfortable textarea { padding: 8px 10px; }
    #editorModal .editor-root.comfortable #pane_visual details > summary { padding: 8px !important; }
    #editorModal .editor-root.comfortable #pane_visual details > div { padding: 8px !important; }
    #editorModal .editor-root.comfortable #ed_suite_form,
    #editorModal .editor-root.comfortable #ed_req_form,
    #editorModal .editor-root.comfortable #ed_assert_form,
    #editorModal .editor-root.comfortable #ed_flow_form,
    #editorModal .editor-root.comfortable #ed_retry_form,
    #editorModal .editor-root.comfortable #ed_oapi_form { gap: 10px !important; }
    /* Overlay and modal layout classes */
    #editorModal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 9999; }
    .editor-root { background: var(--bg); color: var(--txt); position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); width: 90vw; height: 88vh; border: 1px solid var(--bd); border-radius: 8px; display: flex; flex-direction: column; min-height: 0; }
    .ed-header { padding: 8px 12px; border-bottom: 1px solid var(--bd); display: flex; gap: 12px; align-items: center; justify-content: space-between; position: sticky; top: 0; background: var(--bg); z-index: 2; }
    .ed-header-left { display: flex; align-items: center; gap: 12px; }
    .ed-actions { display: flex; gap: 8px; align-items: center; }
    .ed-main { display: flex; gap: 8px; flex: 1; overflow: hidden; min-height: 0; }
    .ed-pane { display: flex; flex: 1 1 auto; gap: 8px; overflow: auto; padding: 8px; min-width: 0; min-height: 0; }
    .ed-tests-panel { flex: 0 0 280px; border: 1px solid var(--bd); border-radius: 6px; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
    .ed-tests-header { padding: 8px; border-bottom: 1px solid var(--bd); font-weight: 600; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: var(--bg); z-index: 1; }
    .ed-tests-list { flex: 1; overflow: auto; min-height: 0; }
    .ed-center { flex: 1 1 auto; display: flex; flex-direction: column; gap: 8px; overflow: auto; min-height: 0; min-width: 640px; }
    .ed-panel { border: 1px solid var(--bd); border-radius: 6px; overflow: visible; }
    .ed-panel.tight { overflow: hidden; }
    .ed-summary { padding: 8px; border-bottom: 1px solid var(--bd); font-weight: 600; cursor: pointer; }
    .ed-body { padding: 8px; }
    .ed-grid-2-140 { display: grid; grid-template-columns: 140px 1fr; gap: 8px; }
    .ed-grid-2-130 { display: grid; grid-template-columns: 130px 1fr; gap: 8px; }
    .ed-grid-2-160 { display: grid; grid-template-columns: 160px 1fr; gap: 8px; }
    .ed-spacer-8 { height: 8px; }
    .ed-subhead { font-weight: 600; margin-bottom: 6px; }
    .ed-splitter { flex: 0 0 6px; cursor: col-resize; background: var(--bd); border-radius: 4px; align-self: stretch; }
    .ed-right { flex: 0 1 30%; margin: 8px; border: 1px solid var(--bd); border-radius: 6px; display: flex; flex-direction: column; min-width: 340px; max-width: 50%; resize: horizontal; overflow: auto; min-height: 0; }
    .ed-right-title { padding: 8px; border-bottom: 1px solid var(--bd); font-weight: 600; position: sticky; top: 0; background: var(--bg); z-index: 1; }
    .ed-preview { padding: 8px; overflow: auto; display: flex; flex-direction: column; gap: 6px; flex: 1 1 auto; min-height: 0; }
    .ed-section { border: 1px solid var(--bd); border-radius: 6px; overflow: auto; display: flex; flex-direction: column; min-height: 0; }
    .ed-section summary { padding: 6px; font-weight: 600; cursor: pointer; position: sticky; top: 0; background: var(--bg); z-index: 1; }
    .ed-scroll { padding: 6px; overflow: auto; max-height: 40vh; }
    .text-error { color: #ef4444; }
    .text-warning { color: #f59e0b; }
    .text-success { color: #10b981; }
  .ed-tabs { gap: 6px; }
  .ed-row-6 { display: flex; gap: 6px; }
  .ed-row-8 { display: flex; gap: 8px; }
  .ed-ai-center { align-items: center; }
  .ed-ai-start { align-items: flex-start; }
  .ed-justify-between { justify-content: space-between; }
  .ed-col-span-full { grid-column: 1 / -1; }
  .ed-mt-6 { margin-top: 6px; }
  .ed-textarea-md { height: 140px; }
  .ed-mono-dim { font-family: monospace; opacity: .85; }
  .ed-grid-1-1-auto { display: grid; grid-template-columns: 1fr 1fr auto; gap: 6px; }
  .ed-grid-1-auto { display: grid; grid-template-columns: 1fr auto; gap: 6px; }
  .m-0 { margin: 0; }
  .w-64px { width: 64px; }
  .w-120px { width: 120px; }
  .w-full { width: 100%; }
  .h-80px { height: 80px; }
  .wrap { flex-wrap: wrap; }
  .gap-4px { gap: 4px; }
  .flex-1 { flex: 1; }
  .fw-600 { font-weight: 600; }
  .hidden { display: none; }
  .ed-grid-col-2 { grid-column: 2 / 3; }
  .ed-grid-140-1-auto2 { display: grid; grid-template-columns: 140px 1fr auto auto; gap: 8px; align-items: center; }
  .dim { opacity: .8; }
  .tab.disabled { opacity: .5; pointer-events: none; }
  .ed-disabled { opacity: .6; pointer-events: none; }
  </style>
</head>
<body>
  <header>
    <div style="display:flex; align-items:center; gap:12px">
      <img id="hydreq_logo" src="/logo_notext.svg" alt="HydReq" style="height:36px; width:36px; display:block;"/>
      <div>HydReq — Hydra Request</div>
    </div>
    <div class="row m-0">
  <label class="row m-0"><input id="onlyFailed" type="checkbox"/> Only failed</label>
  <label class="row m-0"><input id="autoScroll" type="checkbox"/> Auto-scroll</label>
  <label class="row m-0" title="Theme"><span style="margin-right:6px">Theme</span>
    <select id="themeSelect">
      <option value="light">Light</option>
      <option value="dark">Dark</option>
      <option value="synthwave">Synthwave</option>
      <option value="hack">Hack</option>
      <option value="catppuccin-mocha">Catppuccin Mocha</option>
      <option value="catppuccin-latte">Catppuccin Latte</option>
    </select>
  </label>
  <button id="cancel" class="btn btn-sm btn-error" title="Cancel current run (s)">Stop</button>
    </div>
  </header>
  <main>
    <aside>
  <div class="row">
  <button id="refresh" class="btn btn-sm" title="Rescan testdata for *.yaml suites">Refresh</button>
    <button id="newSuiteBtn" class="btn btn-sm" title="Create a new test suite">New Suite</button>
    <label>Workers <input id="workers" type="number" min="1" max="64" value="4" class="w-64px"/></label>
        <label>Tags <input id="tags" type="text" placeholder="smoke,slow" class="w-120px"/></label>
        <label>Default timeout (ms) <input id="defaultTimeout" type="number" min="0" placeholder="30000" class="w-120px"/></label>
      </div>
      <details>
        <summary>Env overrides</summary>
        <div class="row">
          <textarea id="env_kv" placeholder="KEY=VALUE (one per line)" class="w-full h-80px"></textarea>
        </div>
        <div class="row wrap gap-4px" id="env_active"></div>
      </details>
      <details>
        <summary>Import Collection</summary>
        <div class="row">
          <select id="importFormat" class="w-full">
            <option value="postman">Postman Collection (JSON)</option>
            <option value="insomnia">Insomnia Export (JSON)</option>
            <option value="har">HAR Archive (JSON)</option>
            <option value="openapi">OpenAPI/Swagger Spec (YAML/JSON)</option>
            <option value="bruno">Bruno Export (JSON)</option>
            <option value="restclient">REST Client (.http)</option>
            <option value="newman">Newman Collection (JSON)</option>
          </select>
        </div>
        <div class="row">
          <input type="file" id="importFile" accept=".json,.yaml,.yml,.har,.http" class="w-full"/>
        </div>
        <div class="row">
          <button id="importBtn" class="btn btn-sm btn-secondary">Import</button>
          <span id="importStatus" class="text-sm ml-2"></span>
        </div>
      </details>
      <ul id="suites"></ul>
      <div class="row ed-row-6">
        <button id="run" class="btn btn-primary btn-sm">Run Selected</button>
        <span class="pill badge" id="selCount">0 selected</span>
      </div>
    </aside>
    <section>
      <div class="row"><div class="flex-1">Batch progress</div><div class="pill" id="batchText">0/0</div></div>
      <div class="progress"><div id="batchBar"></div></div>
      <div class="ed-spacer-8"></div>
  <div class="row"><div class="flex-1">Suite progress — <span id="currentSuite">(none)</span></div><div class="pill" id="suiteText">0/0</div></div>
      <div class="progress"><div id="suiteBar"></div></div>
      <div id="stages"></div>
  <div class="row" style="justify-content:space-between;align-items:center">
    <div class="row ed-row-6 ed-ai-center"><h3 style="margin:0">Results</h3><span class="dim" title="For CI artifacts use CLI flags --report-json / --report-junit">(Reports via CLI)</span></div>
    <div class="row ed-row-6 ed-ai-center">
      <button id="downloadRunJSON" class="btn btn-sm" title="Download run JSON">Run JSON</button>
      <button id="downloadRunJUnit" class="btn btn-sm" title="Download run JUnit">Run JUnit</button>
      <button id="downloadRunHTML" class="btn btn-sm" title="Download run HTML">Run HTML</button>
      <button id="clearLog" class="btn btn-sm" title="Clear the console output">Clear</button>
    </div>
      </div>
      <div id="results" class="log"></div>
    </section>
  </main>
  <script>
  // Utility: create a safe filename from a suite name
  function slugify(name) {
    return name.toLowerCase()
               .replace(/[^\w\s-]/g, '')
               .trim()
               .replace(/\s+/g, '-')
               .replace(/-+/g, '-');
  }

  async function promptNewSuite() {
    const name = prompt('Enter suite name (e.g. My API tests):');
    if (!name) return;
    const slug = slugify(name);
    const path = 'testdata/' + slug + '.yaml';
    // quick client-side validation
    if (!path.startsWith('testdata/') || (!path.endsWith('.yaml') && !path.endsWith('.yml'))) {
      alert('Invalid path generated. Please choose a different name.');
      return;
    }

    // Check existence via the editor endpoint (returns 200 if exists)
    try {
      const resp = await fetch('/api/editor/suite?path=' + encodeURIComponent(path));
      if (resp.ok) {
        if (!confirm('A suite already exists at ' + path + '. Overwrite?')) return;
      }
    } catch (e) {
      // ignore network errors; we'll still open editor for new file
    }

    const parsed = {
      name: name,
      baseUrl: "",
      vars: {},
      tests: [
        { name: "example test", request: { method: "GET", url: "/" }, assert: { status: 200 } }
      ]
    };

    try {
      openEditor(path, parsed);
    } catch (e) {
      console.error('openEditor failed', e);
      alert('Failed to open editor: ' + (e && e.message ? e.message : e));
    }
  }

  const suitesEl = document.getElementById('suites');
    const selCount = document.getElementById('selCount');
    const workersEl = document.getElementById('workers');
  const envKV = document.getElementById('env_kv');
  const envActive = document.getElementById('env_active');
    const batchBar = document.getElementById('batchBar');
    const batchText = document.getElementById('batchText');
  const suiteBar = document.getElementById('suiteBar');
  const tagsEl = document.getElementById('tags');
  const defToEl = document.getElementById('defaultTimeout');
  const currentSuiteEl = document.getElementById('currentSuite');
    const suiteText = document.getElementById('suiteText');
    const results = document.getElementById('results');
    const stages = document.getElementById('stages');
  const themeSelect = document.getElementById('themeSelect');
  const onlyFailed = document.getElementById('onlyFailed');
  const autoScroll = document.getElementById('autoScroll');
  const cancelBtn = document.getElementById('cancel');

  let selected = new Set(JSON.parse(localStorage.getItem('hydreq.sel')||'[]'));
    let batch = { done: 0, total: 0 };
    let suite = { done: 0, total: 0 };
  const testRows = new Map(); // Name -> {container, line}
  const agg = { passed:0, failed:0, skipped:0, total:0, suites:0, durationMs:0 };
  function scrollBottom(){ if (autoScroll.checked) { results.scrollTop = results.scrollHeight; } }
  let currentRunId = null;
  let lastRunId = null; // retain last run id for downloads after completion

    function pct(d,t){ return t>0 ? Math.min(100, Math.round(100*d/t)) : 0; }
    function setBar(el, d, t){ el.style.width = pct(d,t) + '%'; }
    function parseEnv(){
      const env = {};
      const lines = envKV.value.split(/\n/);
      for (const line of lines){
        const s = line.trim(); if (!s) continue; const eq = s.indexOf('=');
        if (eq>0){ const k=s.slice(0,eq).trim(); const v=s.slice(eq+1).trim(); if(k) env[k]=v; }
      }
      return env;
    }
    function renderActiveEnv(env){
      envActive.innerHTML='';
      Object.keys(env).forEach(k=>{ const b=document.createElement('span'); b.className='pill'; b.textContent=k; envActive.appendChild(b); });
    }

    function renderSuites(list){
      suitesEl.innerHTML = '';
  console.log('renderSuites: rendering', list.length, 'items');
  list.forEach(item => {
        // new server shape: { path: string, name?: string }
        const path = (typeof item === 'string') ? item : (item.path || item.Path || item.file || JSON.stringify(item));
        const pathKey = path; // canonical string key for selection and fetches
        const base = (typeof path === 'string' ? path.split('/').pop() : String(path));
        const friendly = (item && item.name) ? item.name : null;
  // (no-op removed) keep DOM operations explicit so per-button handlers always read their own data attributes
        const li = document.createElement('li'); li.style.display='flex'; li.style.alignItems='center'; li.style.justifyContent='space-between'; li.style.gap='8px';
        // Title + filename layout (name column is taller so long names wrap)
        const name = document.createElement('span'); name.style.flex='1'; name.style.display='flex'; name.style.flexDirection='column'; name.style.alignItems='flex-start'; name.style.gap='2px';
        const titleRow = document.createElement('div'); titleRow.style.display='flex'; titleRow.style.flexDirection='row'; titleRow.style.alignItems='baseline'; titleRow.style.gap='8px';
        const titleSpan = document.createElement('span'); titleSpan.className = 'spec-title'; titleSpan.style.fontWeight='600'; titleSpan.style.fontSize='14px';
        titleSpan.textContent = friendly && (typeof friendly === 'string') && friendly.trim() !== '' ? friendly : base;
        const fileSpan = document.createElement('span'); fileSpan.textContent = base; fileSpan.style.opacity = 0.6; fileSpan.style.fontSize = '12px'; fileSpan.className = 'spec-file';
        titleRow.appendChild(titleSpan); titleRow.appendChild(fileSpan);
        name.appendChild(titleRow);
        const editBtn = document.createElement('button'); editBtn.textContent='Edit'; editBtn.title='Open editor';
        editBtn.dataset.path = pathKey;
        editBtn.addEventListener('click', async (e)=>{
          e.stopPropagation();
          const btn = e.currentTarget;
          const pth = btn && btn.getAttribute && btn.getAttribute('data-path');
          console.log('editBtn clicked, data-path=', pth);
          if (!pth) { console.error('Edit handler: missing data-path on clicked element'); return; }
          const res = await fetch('/api/editor/suite?path='+encodeURIComponent(pth));
          if (!res.ok){ alert('Failed to load suite'); return; }
          const data = await res.json();
          try { openEditor(pth, data); } catch (err) { console.error('openEditor failed', err); alert('Failed to open editor: '+ (err && err.message ? err.message : err)); }
        });
        // Compact download dropdown
        const dlWrap = document.createElement('span'); dlWrap.style.position='relative'; dlWrap.style.display='inline-block';
        const dlBtn = document.createElement('button'); dlBtn.className='btn btn-ghost btn-xs'; dlBtn.textContent='▾'; dlBtn.title='Download';
        dlBtn.dataset.path = pathKey;
        const dlMenu = document.createElement('div'); dlMenu.style.position='absolute'; dlMenu.style.right='0'; dlMenu.style.top='28px'; dlMenu.style.minWidth='140px'; dlMenu.style.border='1px solid var(--bd)'; dlMenu.style.background='var(--bg)'; dlMenu.style.padding='6px'; dlMenu.style.borderRadius='6px'; dlMenu.style.boxShadow='0 6px 12px rgba(0,0,0,0.08)'; dlMenu.style.display='none'; dlMenu.style.zIndex='10';
        const addDl = (label, fmt)=>{ const b = document.createElement('div'); b.textContent = label; b.style.padding='6px'; b.style.cursor='pointer'; b.style.borderRadius='4px'; b.onclick = (e)=>{ e.stopPropagation(); const p = dlBtn.getAttribute && dlBtn.getAttribute('data-path'); if (!p) { console.error('download: missing data-path'); return; } downloadSuite(p, fmt); dlMenu.style.display='none'; }; b.onmouseenter = ()=> b.style.background='var(--li-hov)'; b.onmouseleave = ()=> b.style.background='transparent'; dlMenu.appendChild(b); };
        addDl('Download JSON','json'); addDl('Download JUnit','junit'); addDl('Download HTML','html');
        dlBtn.addEventListener('click', (e)=>{ e.stopPropagation(); dlMenu.style.display = (dlMenu.style.display === 'none') ? 'block' : 'none'; });
        document.addEventListener('click', ()=>{ try{ dlMenu.style.display='none'; }catch{} });
        dlWrap.appendChild(dlBtn); dlWrap.appendChild(dlMenu);
        li.appendChild(name); li.appendChild(dlWrap); li.appendChild(editBtn);
        if (selected.has(pathKey)) li.classList.add('selected');
        li.onclick = () => { if (selected.has(pathKey)) selected.delete(pathKey); else selected.add(pathKey); localStorage.setItem('hydreq.sel', JSON.stringify(Array.from(selected))); selCount.textContent = selected.size + ' selected'; renderSuites(list); };
        suitesEl.appendChild(li);
      });
      selCount.textContent = selected.size + ' selected';
    }

    async function refresh(){
      const res = await fetch('/api/editor/suites');
      const list = await res.json();
      renderSuites(list);
    }

    async function run(){
      let suites = Array.from(selected);
      if (suites.length === 0) {
        // If user hasn't selected any suites, default to all discovered suites
        // Use the editor suites endpoint which may return objects {path,name}
        const resAll = await fetch('/api/editor/suites');
        if (!resAll.ok) { alert('No suites selected and failed to load suites'); return; }
        const alllist = await resAll.json();
        // normalize to string paths
        suites = alllist.map(i => (typeof i === 'string') ? i : (i.path || i.Path || JSON.stringify(i)));
      }
      const env = parseEnv();
      renderActiveEnv(env);
  const tags = (tagsEl && tagsEl.value)? tagsEl.value.split(',').map(s=>s.trim()).filter(Boolean) : [];
  const defaultTimeoutMs = (defToEl && defToEl.value)? (parseInt(defToEl.value,10)||0) : 0;
  const res = await fetch('/api/run', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({suites, workers: parseInt(workersEl.value)||4, tags: (tags.length? tags: undefined), defaultTimeoutMs: (defaultTimeoutMs>0? defaultTimeoutMs: undefined), env})});
      if (!res.ok){
        let txt = '';
        try { txt = await res.text(); } catch {}
        alert('Run failed: ' + res.status + (txt?(' - '+txt):''));
        return;
      }
  const { runId } = await res.json();
  currentRunId = runId;
  listen(runId);
    }

    async function importCollection(){
      const format = document.getElementById('importFormat').value;
      const fileInput = document.getElementById('importFile');
      const statusEl = document.getElementById('importStatus');
      
      if (!fileInput.files.length) {
        statusEl.textContent = 'Please select a file';
        return;
      }
      
      const file = fileInput.files[0];
      statusEl.textContent = 'Importing...';
      
      const formData = new FormData();
      formData.append('file', file);
      formData.append('format', format);
      
      try {
        const res = await fetch('/api/import', { method: 'POST', body: formData });
        if (!res.ok) {
          const error = await res.text();
          statusEl.textContent = 'Import failed: ' + error;
          return;
        }
        
        const yaml = await res.text();
        // Create a download link for the YAML
        const blob = new Blob([yaml], { type: 'application/x-yaml' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'imported-suite.yaml';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        statusEl.textContent = 'Import successful! Downloaded as imported-suite.yaml';
        fileInput.value = '';
      } catch (e) {
        statusEl.textContent = 'Import failed: ' + e.message;
      }
    }

    function listen(id){
  batch = { done:0, total:0 }; suite = { done:0, total:0 };
  results.textContent=''; stages.innerHTML=''; testRows.clear(); agg.passed=agg.failed=agg.skipped=agg.total=agg.suites=agg.durationMs=0; setBar(batchBar,0,1); setBar(suiteBar,0,1); batchText.textContent='0/0'; suiteText.textContent='0/0';
      const es = new EventSource('/api/stream?runId=' + encodeURIComponent(id));
      es.onmessage = (e)=>{
        const ev = JSON.parse(e.data);
        const type = ev.type;
        const payload = ev.payload || {};
        if (type === 'testStart'){
          const {Name} = payload;
          const wrap = document.createElement('div');
          const line = document.createElement('div'); line.className='run'; line.textContent = '… ' + Name;
          wrap.appendChild(line);
          results.appendChild(wrap);
          testRows.set(Name, {container: wrap, line});
          scrollBottom();
        }
        if (type === 'batchStart'){
          batch.total = payload.total; batch.done = 0; setBar(batchBar,0,batch.total); batchText.textContent = '0/' + batch.total;
        }
        if (type === 'suiteStart'){
          suite.total = payload.total; suite.done = 0; setBar(suiteBar,0,suite.total); suiteText.textContent = '0/' + suite.total; stages.innerHTML='';
          currentSuiteEl.textContent = (payload.name || payload.path || '');
          // log start of suite
          const nm = (payload.name || payload.path || '');
          const ln = document.createElement('div'); ln.textContent = `=== running: ${nm} ===`; results.appendChild(ln);
          scrollBottom();
          const stageMap = payload.stages || {};
          for(const k in stageMap){
            const d=document.createElement('div'); d.className='row';
            d.innerHTML='<div class="w-120px">stage '+k+'</div><div class="progress flex-1"><div id="stage_'+k+'" style="width:0%"></div></div><div class="pill" id="stage_txt_'+k+'">0/'+stageMap[k]+'</div>';
            stages.appendChild(d);
          }
        }
        if (type === 'test'){
          const {Name, Status, DurationMs, Stage, Messages} = payload;
          agg.total++;
          if (Status==='passed') agg.passed++; else if (Status==='failed') agg.failed++; else if (Status==='skipped') agg.skipped++;
          if (onlyFailed.checked && Status !== 'failed') {
            const row = testRows.get(Name); if (row) { row.container.remove(); testRows.delete(Name); }
          } else {
            let row = testRows.get(Name);
            if (!row){
              const wrap = document.createElement('div');
              const line = document.createElement('div'); wrap.appendChild(line); results.appendChild(wrap);
              row = {container: wrap, line}; testRows.set(Name, row);
            }
            row.line.className = (Status==='passed'?'ok':(Status==='failed'?'fail':'skip'));
            row.line.textContent = (Status==='passed'?'✓':(Status==='failed'?'✗':'-')) + ' ' + Name + ' (' + DurationMs + ' ms)';
            if (Status==='failed' && Array.isArray(Messages) && Messages.length){
              let det = row.container.querySelector('details');
              if (!det){ det = document.createElement('details'); const sum=document.createElement('summary'); sum.textContent='details'; det.appendChild(sum); row.container.appendChild(det); }
              let pre = det.querySelector('pre'); if (!pre){ pre = document.createElement('pre'); pre.className='fail'; det.appendChild(pre); }
              pre.textContent = Messages.join('\n');
            }
            scrollBottom();
          }
          // progress and stages after rendering
          suite.done++; setBar(suiteBar, suite.done, suite.total); suiteText.textContent = suite.done + '/' + suite.total;
          const st = document.getElementById('stage_'+Stage); const stt = document.getElementById('stage_txt_'+Stage);
          if(st && stt){ const txt = stt.textContent.split('/'); const done = (parseInt(txt[0],10)||0)+1; const total = parseInt(txt[1],10)||0; st.style.width = pct(done,total)+'%'; stt.textContent = done+'/'+total; }
        }
        if (type === 'suiteEnd'){
          batch.done++; setBar(batchBar, batch.done, batch.total); batchText.textContent = batch.done + '/' + batch.total;
          const name = payload.name || payload.path || '';
          const s = payload.summary || {};
          const line = `=== ${name} — ${s.passed||0} passed, ${s.failed||0} failed, ${s.skipped||0} skipped, total ${s.total||0} in ${(s.durationMs||0)} ms ===`;
          const div = document.createElement('div'); div.textContent = line; results.appendChild(div);
          agg.suites++; agg.durationMs += (s.durationMs||0);
          scrollBottom();
        }
        if (type === 'batchEnd'){
          const div = document.createElement('div'); div.textContent = `=== Batch summary — ${agg.passed} passed, ${agg.failed} failed, ${agg.skipped} skipped, total ${agg.total} in ${agg.durationMs} ms (suites ${agg.suites}/${batch.total}) ===`; results.appendChild(div);
          scrollBottom();
        }
        if (type === 'error'){ const d = document.createElement('div'); d.className='fail'; d.textContent = 'Error: ' + (payload.error||''); results.appendChild(d); }
        if (type === 'done'){ es.close(); lastRunId = id; currentRunId = null; }
      };
    }

    // Theming system
    function themeToDaisy(name){
      switch(name){
        case 'dark': return 'dark';
        case 'synthwave': return 'synthwave';
        case 'hack': return 'forest'; // closest built-in for DaisyUI components
        case 'catppuccin-mocha': return 'dracula';
        case 'catppuccin-latte': return 'cupcake';
        default: return 'light';
      }
    }
    function isDocDark(){
      return document.body.classList.contains('dark') ||
             document.body.classList.contains('hack') ||
             document.body.classList.contains('catppuccin-mocha');
    }
    function applyTheme(name){
      const root = document.documentElement;
      root.setAttribute('data-theme', themeToDaisy(name));
      document.body.classList.toggle('dark', name === 'dark' || name === 'synthwave');
      document.body.classList.toggle('synthwave', name === 'synthwave');
      document.body.classList.toggle('hack', name === 'hack');
      document.body.classList.toggle('catppuccin-mocha', name === 'catppuccin-mocha');
      document.body.classList.toggle('catppuccin-latte', name === 'catppuccin-latte');
      try { localStorage.setItem('hydreq.theme', name); } catch{}
      // Sync CodeMirror theme
      try { if (typeof syncEditorTheme === 'function') syncEditorTheme(); } catch{}
    }
    (function initTheme(){
      let saved = 'dark';
      try { saved = localStorage.getItem('hydreq.theme') || 'dark'; } catch{}
      if (themeSelect) { themeSelect.value = saved; themeSelect.addEventListener('change', ()=> applyTheme(themeSelect.value)); }
      applyTheme(saved);
    })();

    document.getElementById('refresh').onclick = refresh;
    document.getElementById('run').onclick = run;
    document.getElementById('importBtn').onclick = importCollection;
  try { document.getElementById('newSuiteBtn').onclick = promptNewSuite; } catch(e){}
  // per-suite edit buttons are rendered inline in the list

  function openEditor(path, data){
    // Accept either the server response shape { raw, parsed } or a parsed suite
    // object directly (promptNewSuite passes parsed directly). Normalize so the
    // rest of the code can always read data.parsed.
    try {
      if (data && !data.parsed && (data.name || data.Name || Array.isArray(data.tests))) {
        data = { parsed: data };
      }
    } catch (e) {}
    // Visual + YAML editor modal (MVP)
    let modal = document.getElementById('editorModal');
    if (!modal){
      modal = document.createElement('div'); modal.id='editorModal'; modal.innerHTML = `
        <div class="editor-root">
          <div class="ed-header">
            <div class="ed-header-left">
              <div class="fw-600">Edit: <span id="ed_path"></span></div>
              <div class="tabs tabs-boxed ed-tabs">
                <button id="tab_visual" class="tab tab-active">Visual</button>
                <button id="tab_yaml" class="tab">YAML</button>
              </div>
            </div>
            <div class="ed-actions">
              <label class="label cursor-pointer ed-row-6 ed-ai-center">
                <span class="label-text">Comfortable</span>
                <input id="ed_density" type="checkbox" class="toggle toggle-sm" title="Toggle comfortable density">
              </label>
              <label class="label cursor-pointer ed-row-6 ed-ai-center" title="Include dependsOn when running the selected test">
                <span class="label-text">with deps</span>
                <input id="ed_run_with_deps" type="checkbox" class="toggle toggle-sm">
              </label>
              <button id="ed_run_test" class="btn btn-sm" title="Validate and run the selected test without saving">Run test</button>
              <button id="ed_validate" class="btn btn-sm">Validate</button>
              <button id="ed_save" class="btn btn-sm">Save</button>
              <button id="ed_save_close" class="btn btn-sm">Save & Close</button>
              <button id="ed_close" type="button" class="btn btn-sm">Close</button>
              <span id="ed_dirty_indicator" class="pill" title="You have unsaved changes" style="margin-left:8px; display:none; background:#fde2e1; color:#b91c1c">Unsaved</span>
            </div>
          </div>
          <div class="ed-main">
            <div id="pane_visual" class="ed-pane">
              <div class="ed-tests-panel">
                <div class="ed-tests-header">
                  <span>Tests</span>
                  <span class="ed-row-6">
                    <button id="ed_add_test" class="btn btn-xs" title="Add test">+</button>
                    <button id="ed_del_test" class="btn btn-xs" title="Delete selected">−</button>
                  </span>
                </div>
                <div id="ed_tests" class="ed-tests-list"></div>
              </div>
              <div class="ed-center">
                <details open class="ed-panel">
                  <summary class="ed-summary">Suite</summary>
                  <div class="ed-body ed-grid-2-140" id="ed_suite_form">
                    <label>Name</label>
                    <input id="ed_suite_name" type="text"/>
                    <label>Base URL</label>
                    <input id="ed_suite_baseurl" type="text" placeholder="https://api.example.com"/>
                    <label class="ed-col-span-full ed-mt-6 fw-600">Variables</label>
                    <div class="ed-col-span-full" id="ed_suite_vars"></div>
                    <label class="ed-col-span-full ed-mt-6 fw-600">Auth</label>
                    <div class="ed-col-span-full ed-grid-2-160">
                      <label>Bearer env</label>
                      <div class="ed-row-8 ed-ai-center">
                        <input id="ed_auth_bearer" type="text" placeholder="DEMO_BEARER"/>
                        <span id="ed_auth_bearer_status" class="pill" title="env presence">?</span>
                      </div>
                      <label>Basic env</label>
                      <div class="ed-row-8 ed-ai-center">
                        <input id="ed_auth_basic" type="text" placeholder="BASIC_B64"/>
                        <span id="ed_auth_basic_status" class="pill" title="env presence">?</span>
                      </div>
                    </div>
                    <div class="ed-col-span-full ed-grid-2-160 ed-ai-center">
                      <label>Auth header (preview)</label>
                      <div id="ed_auth_preview" class="ed-mono-dim">(none)</div>
                    </div>
                    <div class="ed-col-span-full ed-grid-2-160 ed-ai-start">
                      <label>Suite hooks</label>
                      <div>
                        <div class="ed-subhead">preSuite</div>
                        <div id="ed_suite_presuite"></div>
                        <div class="ed-spacer-8"></div>
                        <div class="ed-subhead">postSuite</div>
                        <div id="ed_suite_postsuite"></div>
                      </div>
                    </div>
                  </div>
                </details>
                <details open class="ed-panel">
                  <summary class="ed-summary">Request</summary>
                  <div class="ed-body ed-grid-2-130" id="ed_req_form">
                    <label>Method</label>
                    <select id="ed_method">
                      <option>GET</option><option>POST</option><option>PUT</option><option>PATCH</option><option>DELETE</option><option>HEAD</option><option>OPTIONS</option>
                    </select>
                    <label>URL path</label>
                    <input id="ed_url" type="text"/>
                    <label>Test name</label>
                    <input id="ed_test_name" type="text" placeholder="My test name" />
                    <label>Timeout (ms)</label>
                    <input id="ed_timeout" type="number" min="0"/>
                    <label class="ed-col-span-full ed-mt-6 fw-600">Headers</label>
                    <div class="ed-col-span-full" id="ed_headers"></div>
                    <label class="ed-col-span-full ed-mt-6 fw-600">Query</label>
                    <div class="ed-col-span-full" id="ed_query"></div>
                    <label class="ed-col-span-full ed-mt-6 fw-600">Body (JSON/YAML)</label>
                    <textarea id="ed_body" class="ed-col-span-full ed-textarea-md"></textarea>
                  </div>
                </details>

                <details open class="ed-panel">
                  <summary class="ed-summary">Assertions</summary>
                  <div class="ed-body ed-grid-2-160" id="ed_assert_form">
                    <label>Status</label>
                    <input id="ed_assert_status" type="number" min="0"/>
                    <label>Header equals</label>
                    <div id="ed_assert_headerEquals" class="ed-grid-col-2"></div>
                    <label>JSON equals (path → value)</label>
                    <div id="ed_assert_jsonEquals" class="ed-grid-col-2"></div>
                    <label>JSON contains (path → value)</label>
                    <div id="ed_assert_jsonContains" class="ed-grid-col-2"></div>
                    <label>Body contains</label>
                    <div id="ed_assert_bodyContains" class="ed-grid-col-2"></div>
                    <label>Max duration (ms)</label>
                    <input id="ed_assert_maxDuration" type="number" min="0"/>
                  </div>
                </details>

                <details open class="ed-panel">
                  <summary class="ed-summary">Extract variables</summary>
                  <div class="ed-body" id="ed_extract"></div>
                </details>

                <details open class="ed-panel">
                  <summary class="ed-summary">Flow & Meta</summary>
                  <div class="ed-body ed-grid-2-160" id="ed_flow_form">
                    <label>Skip</label>
                    <input id="ed_skip" type="checkbox"/>
                    <label>Only</label>
                    <input id="ed_only" type="checkbox"/>
                    <label>Stage</label>
                    <input id="ed_stage" type="number" min="0"/>
                    <label>Tags (comma sep)</label>
                    <input id="ed_tags" type="text"/>
                    <label>Depends on (comma sep)</label>
                    <input id="ed_depends" type="text"/>
                  </div>
                </details>

                <details open class="ed-panel">
                  <summary class="ed-summary">Test hooks</summary>
                  <div class="ed-body">
                    <div class="ed-subhead">pre</div>
                    <div id="ed_test_prehooks"></div>
                    <div class="ed-spacer-8"></div>
                    <div class="ed-subhead">post</div>
                    <div id="ed_test_posthooks"></div>
                  </div>
                </details>

                <details open class="ed-panel">
                  <summary class="ed-summary">Retry</summary>
                  <div class="ed-body ed-grid-2-160" id="ed_retry_form">
                    <label>Enable retry</label>
                    <input id="ed_retry_enable" type="checkbox"/>
                    <label>Max attempts</label>
                    <input id="ed_retry_max" type="number" min="0"/>
                    <label>Backoff (ms)</label>
                    <input id="ed_retry_backoff" type="number" min="0"/>
                    <label>Jitter (%)</label>
                    <input id="ed_retry_jitter" type="number" min="0" max="100"/>
                  </div>
                </details>

                <details open class="ed-panel tight">
                  <summary class="ed-summary">Matrix</summary>
                  <div class="ed-body" id="ed_matrix"></div>
                </details>

                <details open class="ed-panel tight">
                  <summary class="ed-summary">OpenAPI</summary>
                  <div class="ed-body ed-grid-2-160" id="ed_oapi_form">
                    <label>Per-test override</label>
                    <select id="ed_oapi_enabled">
                      <option value="inherit">Inherit (suite default)</option>
                      <option value="true">Enabled</option>
                      <option value="false">Disabled</option>
                    </select>
                  </div>
                </details>
              </div>
            </div>
            <div id="pane_yaml" class="ed-pane" style="display:none">
              <textarea id="ed_raw" class="hidden"></textarea>
            </div>
            <div id="ed_splitter" class="ed-splitter"></div>
            <div class="ed-right">
              <div class="ed-right-title">Validation & Preview</div>
              <div id="ed_preview" class="ed-preview">
                <details id="ed_quickrun_box" class="ed-section" open>
                  <summary>Quick run</summary>
                  <div id="ed_quickrun" class="log ed-scroll"></div>
                </details>
                <details id="ed_validation_box" class="ed-section" open>
                  <summary class="ed-row-8 ed-ai-center ed-justify-between">
                    <span>Validation</span>
                    <button id="ed_copy_issues" class="btn btn-xs" title="Copy issues">Copy</button>
                  </summary>
                  <div id="ed_issues" class="ed-scroll"></div>
                </details>
              </div>
            </div>
          </div>
        </div>`;
  document.body.appendChild(modal);
  // Prevent page scroll under modal
  document.body.classList.add('modal-open');
  modal.addEventListener('wheel', (e)=>{ e.stopPropagation(); }, { passive: true });
  modal.addEventListener('touchmove', (e)=>{ e.stopPropagation(); }, { passive: true });
      modal.addEventListener('click', (e)=>{ if (e.target === modal) attemptClose(); });
    }
    modal.querySelector('#ed_path').textContent = path;
    const rawEl = modal.querySelector('#ed_raw');
  // If caller provided parsed data, ensure the visual suite name field is prefilled
  // early so the editor shows the name even before full form rendering.
  try {
    const nameFieldEarly = modal.querySelector && modal.querySelector('#ed_suite_name');
    if (data.parsed && nameFieldEarly) {
      const n = (data.parsed && (data.parsed.name || data.parsed.Name)) || '';
      if (n) nameFieldEarly.value = n;
    }
  } catch(e) {}
  const issuesEl = modal.querySelector('#ed_issues');
  const quickRunBox = modal.querySelector('#ed_quickrun');
  const tabVisual = modal.querySelector('#tab_visual');
  const tabYaml = modal.querySelector('#tab_yaml');
  const paneVisual = modal.querySelector('#pane_visual');
  const paneYaml = modal.querySelector('#pane_yaml');
  // Shared in-memory YAML; declare early so we can safely initialize it below.
  let inMemoryYaml = '';
  const densityToggle = modal.querySelector('#ed_density');
  const editorRoot = modal.querySelector('.editor-root');
  const splitter = modal.querySelector('#ed_splitter');
  const rightPane = splitter ? splitter.nextElementSibling : null;
    // Initialize raw editor value. Prefer raw file content when present; otherwise
    // serialize the provided parsed object into canonical YAML so new suites open
    // with a prefilled YAML document (including the suite name).
    if (data.raw && data.raw.trim() !== '') {
      rawEl.value = data.raw;
      inMemoryYaml = data.raw;
    } else if (data.parsed) {
      try {
        // Avoid referencing `working` here because `working` is declared later.
        const dumped = jsyaml.dump(data.parsed || {}, { noRefs: true });
        inMemoryYaml = unquoteNumericKeys(dumped || '');
        rawEl.value = inMemoryYaml;
      } catch (e) {
        rawEl.value = '';
        inMemoryYaml = '';
      }
    } else {
      rawEl.value = '';
    }
    // Initialize CodeMirror for YAML
  // Track if the YAML text was modified by the user since last mirror
  let yamlDirty = false;
  let yamlEditor = null;
    function ensureYamlEditor(){
      if (yamlEditor) return yamlEditor;
      yamlEditor = CodeMirror.fromTextArea(rawEl, {
        mode: 'yaml',
        lineNumbers: true,
        theme: (isDocDark()? 'material-darker':'default'),
        indentUnit: 2,
        tabSize: 2,
        indentWithTabs: false,
        extraKeys: {
          Tab: function(cm){
            if (cm.somethingSelected()) cm.indentSelection('add'); else cm.replaceSelection('  ', 'end');
          },
          'Shift-Tab': function(cm){ cm.indentSelection('subtract'); }
        }
      });
      // Replace any tabs with two spaces on input/paste
      yamlEditor.on('beforeChange', function(cm, change){
        if (!change || !Array.isArray(change.text)) return;
        let changed = false;
        const out = change.text.map(function(line){
          if (line.indexOf('\t') !== -1){ changed = true; return line.replace(/\t/g, '  '); }
          return line;
        });
        if (changed) change.update(change.from, change.to, out, change.origin);
      });
  // Track YAML user edits. Validation is now on-demand (via the Validate button).
  // We still mark the YAML as dirty so switching to Visual will trigger parsing/validation.
  yamlEditor.on('change', function(){ yamlDirty = true; });
      // Resize to fit parent
      setTimeout(()=> yamlEditor.refresh(), 0);
      return yamlEditor;
    }
    issuesEl.innerHTML = '';

    // One-time event delegation: any change within Visual pane updates working model and serializes to the shared YAML
    (function attachVisualDelegates(){
      const root = modal.querySelector('#pane_visual');
      if (!root) return;
      const handler = async ()=>{ try { sync(); await serializeWorkingToYamlImmediate(); } catch {} };
      root.addEventListener('input', ()=>{ handler(); }, true);
      root.addEventListener('change', ()=>{ handler(); }, true);
      root.addEventListener('click', (e)=>{
        const t = e.target;
        if (!t) return;
        // Trigger sync on button clicks (add/remove rows, toggles, etc.)
        if ((t.tagName && t.tagName.toLowerCase()==='button') || t.closest('button')) {
          handler();
        }
      }, true);
    })();

    function normalizeParsed(inObj){
      if (!inObj || typeof inObj !== 'object') return { tests: [] };
      const out = {};
      out.name = inObj.Name || inObj.name || '';
      out.baseUrl = inObj.BaseURL || inObj.baseUrl || '';
      out.vars = inObj.Variables || inObj.vars || {};
      const au = inObj.Auth || inObj.auth || null;
      out.auth = au ? { bearerEnv: (au.BearerEnv || au.bearerEnv || ''), basicEnv: (au.BasicEnv || au.basicEnv || '') } : null;
      // suite hooks
      out.preSuite = inObj.PreSuite || inObj.preSuite || [];
      out.postSuite = inObj.PostSuite || inObj.postSuite || [];
      // suite-level
      const testsArr = Array.isArray(inObj.Tests) ? inObj.Tests : (Array.isArray(inObj.tests) ? inObj.tests : []);
      if (Array.isArray(testsArr)){
        out.tests = testsArr.map(tc=>{
          const t = {};
          t.name = tc.Name || tc.name || '';
          // request
          const rq = tc.Request || tc.request || {};
          t.request = {
            method: rq.Method || rq.method || 'GET',
            url: rq.URL || rq.url || '',
            headers: rq.Headers || rq.headers || {},
            query: rq.Query || rq.query || {},
            body: (rq.Body !== undefined ? rq.Body : rq.body)
          };
          // assert
          const as = tc.Assert || tc.assert || {};
          t.assert = {
            status: as.Status || as.status || 0,
            headerEquals: as.HeaderEquals || as.headerEquals || {},
            jsonEquals: as.JSONEquals || as.jsonEquals || {},
            jsonContains: as.JSONContains || as.jsonContains || {},
            bodyContains: as.BodyContains || as.bodyContains || [],
            maxDurationMs: as.MaxDurationMs || as.maxDurationMs || 0,
          };
          // extract
          const ex = tc.Extract || tc.extract || {};
          const exOut = {};
          Object.keys(ex||{}).forEach(k=>{
            const v = ex[k]||{}; exOut[k] = { jsonPath: v.JSONPath || v.jsonPath || '' };
          });
          t.extract = exOut;
          // flow/meta
          t.skip = !!(tc.Skip ?? tc.skip);
          t.only = !!(tc.Only ?? tc.only);
          t.timeoutMs = tc.TimeoutMs ?? tc.timeoutMs ?? 0;
          t.repeat = tc.Repeat ?? tc.repeat ?? 0;
          t.tags = tc.Tags || tc.tags || [];
          t.stage = tc.Stage ?? tc.stage ?? 0;
          t.vars = tc.Vars || tc.vars || {};
          t.dependsOn = tc.DependsOn || tc.dependsOn || [];
          t.pre = tc.Pre || tc.pre || [];
          t.post = tc.Post || tc.post || [];
          // retry
          const rt = tc.Retry || tc.retry || null;
          t.retry = rt ? { max: rt.Max ?? rt.max ?? 0, backoffMs: rt.BackoffMs ?? rt.backoffMs ?? 0, jitterPct: rt.JitterPct ?? rt.jitterPct ?? 0 } : null;
          // matrix
          t.matrix = tc.Matrix || tc.matrix || {};
          // openapi
          const oa = tc.OpenAPI || tc.openApi || null;
          t.openApi = oa ? { enabled: (oa.Enabled ?? oa.enabled) } : null;
          return t;
        });
      } else {
        out.tests = [];
      }
      return out;
    }
    // working copy of parsed suite for visual editing
    let working = (data.parsed ? normalizeParsed(JSON.parse(JSON.stringify(data.parsed))) : { tests: [] });
  if (!Array.isArray(working.tests)) working.tests = [];
  // Single in-memory YAML source-of-truth. Both visual and YAML editors read/write this.
  // Initialized from raw file content if available; otherwise populated when serializing working.
  if (data.raw && data.raw.trim() !== '') inMemoryYaml = data.raw;
  let selIndex = 0;
  // Cache of quick-run results per test (keyed by index:name), persisted in localStorage per suite path
  const LS_VER = 'v1';
  const LS_ENC = (s)=> { try { return btoa(unescape(encodeURIComponent(s||''))); } catch { return (s||''); } };
  const LS_KEY = (p)=> `hydreq.${LS_VER}.runCache:` + LS_ENC(p||'');
  const persisted = (function(){ try{ return JSON.parse(localStorage.getItem(LS_KEY(path))||'{}') }catch{ return {} } })();
  const testRunCache = new Map(Object.entries(persisted));
  let lastSuiteRun = null;

  let dirty = false;
  function markDirty(){ dirty = true; try{ const di = modal && modal.querySelector && modal.querySelector('#ed_dirty_indicator'); if (di) di.style.display = ''; }catch{} }
  function attemptClose(){ if (dirty && !confirm('Discard unsaved changes?')) return; modal.remove(); document.body.classList.remove('modal-open'); }
    // Serialize working to canonical YAML via server and update shared inMemoryYaml. Then mirror into the editor when appropriate.
    async function serializeWorkingToYamlImmediate(){
      try{
        // Client-side serialization: build a plain object matching the editable model and dump YAML
        const suiteObj = {
          name: working.name || '',
          baseUrl: working.baseUrl || '',
          vars: working.vars || {},
          auth: working.auth || null,
          preSuite: working.preSuite || [],
          postSuite: working.postSuite || [],
          tests: (working.tests||[]).map(t => ({
            name: t.name || '',
            request: t.request || {},
            assert: t.assert || {},
            extract: t.extract || {},
            vars: t.vars || {},
            dependsOn: t.dependsOn || [],
            pre: t.pre || [],
            post: t.post || [],
            retry: t.retry || null,
            matrix: t.matrix || {},
            openApi: t.openApi || null,
            stage: t.stage || 0,
            tags: t.tags || []
          }))
        };
        // Use js-yaml to dump; no refs
        const yraw = jsyaml.dump(suiteObj, { noRefs: true });
        const y = unquoteNumericKeys(yraw);
        inMemoryYaml = y;
        ensureYamlEditor();
        // if YAML tab is visible and user hasn't edited it, keep it synced
        if (paneYaml.style.display !== 'none') {
          if (!yamlDirty && yamlEditor.getValue() !== inMemoryYaml) {
            yamlEditor.setValue(inMemoryYaml);
            yamlDirty = false;
          }
        }
        return { yaml: inMemoryYaml, parsed: suiteObj, issues: [] };
      }catch(e){
        return null;
      }
    }

    async function mirrorYamlFromVisual(force=false){
      // Ensure inMemoryYaml is up-to-date from working, then mirror into editor when appropriate.
      try{
        await serializeWorkingToYamlImmediate();
        ensureYamlEditor();
        if (paneYaml.style.display === 'none' || force) {
          const cur = yamlEditor.getValue();
          if (cur !== inMemoryYaml) yamlEditor.setValue(inMemoryYaml);
          yamlDirty = false;
        }
        yamlEditor.setOption('readOnly', false);
      }catch{}
    }
  // Debounced serialization from Visual to YAML when YAML tab hidden
  const syncYamlPreviewFromVisual = debounce(()=>{ if (paneYaml.style.display === 'none') { try { serializeWorkingToYamlImmediate().catch(()=>{}); } catch{} } }, 300);

    // Remove quotes around purely-numeric mapping keys in YAML string so keys like 1234: value don't become "1234": value
    function unquoteNumericKeys(yamlText){
      if (!yamlText) return yamlText;
      // Replace lines like "  "123": value" with "  123: value" but only for simple mappings
      return yamlText.split('\n').map(line=>{
        // match indentation, quoted key, colon
        const m = line.match(/^(\s*)("|')([0-9]+)("|')\s*:\s*(.*)$/);
        if (m) return m[1] + m[3] + ': ' + m[5];
        return line;
      }).join('\n');
    }
    function setVisualEnabled(enabled){
      // Disable/enable all controls in visual pane and tests list
      const ctrlSel = '#pane_visual input, #pane_visual select, #pane_visual textarea, #pane_visual button';
      modal.querySelectorAll(ctrlSel).forEach(el=>{ el.disabled = !enabled; });
      const testsPanel = modal.querySelector('.ed-tests-panel');
      if (testsPanel){ if (!enabled) testsPanel.classList.add('ed-disabled'); else testsPanel.classList.remove('ed-disabled'); }
      // Disable Visual tab interaction
      if (!enabled) tabVisual.classList.add('disabled'); else tabVisual.classList.remove('disabled');
    }
    function debounce(fn, wait){ let t=null; return function(){ const args=arguments; clearTimeout(t); t=setTimeout(()=> fn.apply(this,args), wait); } }
    async function validateRawAndApply(){
      try{
        ensureYamlEditor();
        const rawText = yamlEditor.getValue();
        inMemoryYaml = rawText;
        // Client-side parse first for instant feedback
        try {
          const parsed = jsyaml.load(rawText);
          // Normalize parsed object into working model
          working = normalizeParsed(parsed || {});
          if (!Array.isArray(working.tests)) working.tests = [];
          setVisualEnabled(true);
          // Update canonical YAML from parsed object to maintain consistent formatting
          try { const dumped = jsyaml.dump(parsed || {}, { noRefs: true }); inMemoryYaml = unquoteNumericKeys(dumped); } catch(e) {}
          renderIssues([], inMemoryYaml);
          lastValidated = { OK: true, Issues: [], Parsed: parsed, YAML: inMemoryYaml };
          if (paneVisual.style.display !== 'none'){ renderTests(); renderForm(); }
        } catch(parseErr){
          // YAML parse error: show issue and disable Visual
          const msg = parseErr && parseErr.message ? parseErr.message : String(parseErr);
          renderIssues([{ path: 'root', message: 'YAML parse error: ' + msg, severity: 'error' }], rawText);
          setVisualEnabled(false);
          lastValidated = { OK: false, Issues: [{ path: 'root', message: msg, severity: 'error' }], Parsed: null, YAML: rawText };
        }
      }catch{}
    }
    async function switchTab(which){
      if (which === 'visual'){
        // If YAML has been modified, re-validate and sync to working before showing Visual
        if (yamlDirty) { await validateRawAndApply(); yamlDirty = false; }
        paneVisual.style.display='flex'; paneYaml.style.display='none';
        tabVisual.classList.add('tab-active'); tabYaml.classList.remove('tab-active');
        // Ensure Visual reflects latest parsed YAML
        try { renderTests(); renderForm(); } catch {}
        // Refresh Visual quick-run box from per-test cache and clear YAML validation snapshot
        try { renderQuickRunForSelection(); } catch {}
        try {
          issuesEl.innerHTML='';
          const valBox = modal.querySelector('#ed_validation_box'); if (valBox) valBox.open = false;
        } catch {}
      } else {
        paneVisual.style.display='none'; paneYaml.style.display='flex';
        tabYaml.classList.add('tab-active'); tabVisual.classList.remove('tab-active');
        ensureYamlEditor(); yamlEditor.refresh();
  // Ensure Visual form is rendered (so getters exist), then synchronize into working and mirror into YAML
  try { renderForm(); } catch {}
  try { sync(); } catch {}
  // Serialize working into inMemoryYaml and push to editor if not edited by user
  try { await serializeWorkingToYamlImmediate(); } catch {}
  if (!yamlDirty) { try { ensureYamlEditor(); const cur = yamlEditor.getValue(); if (cur !== inMemoryYaml) yamlEditor.setValue(inMemoryYaml); } catch {} }
        // Restore YAML-mode cached results/validation (if any)
        try {
          const y = JSON.parse(localStorage.getItem(`hydreq.${LS_VER}.yamlRun:`+LS_ENC(path))||'null');
          const v = JSON.parse(localStorage.getItem(`hydreq.${LS_VER}.yamlVal:`+LS_ENC(path))||'null');
          if (y) { quickRunBox.innerHTML=''; const icon = y.status==='passed'?'✓':(y.status==='failed'?'✗':'-'); const hdr=document.createElement('div'); hdr.style.fontWeight='600'; hdr.style.marginBottom='6px'; hdr.textContent = `${icon} ${y.name||'suite'} (${y.durationMs||0} ms)`; quickRunBox.appendChild(hdr); if (Array.isArray(y.messages)&&y.messages.length){ const pre=document.createElement('pre'); pre.className=(y.status==='failed'?'fail':(y.status==='skipped'?'skip':'ok')); pre.textContent=y.messages.join('\n'); quickRunBox.appendChild(pre);} }
          if (v) { renderIssues(v.issues||[], v.yaml||''); }
        } catch {}
      }
      localStorage.setItem('hydreq.editor.tab', which);
    }
    tabVisual.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); switchTab('visual'); };
    tabYaml.onclick = (e)=>{ e.preventDefault(); e.stopPropagation(); switchTab('yaml'); };

    // Close button robust handler + Escape support
    const closeBtn = modal.querySelector('#ed_close');
    if (closeBtn){ closeBtn.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); attemptClose(); }); }
    document.addEventListener('keydown', function escClose(ev){ if (!document.getElement('editorModal')) { document.removeEventListener('keydown', escClose); return; } if (ev.key === 'Escape'){ attemptClose(); } });

   
    // Draggable splitter for right pane
    (function(){
      if (!splitter || !rightPane) return;
      // Restore saved width if present
      try {
        const w = parseInt(localStorage.getItem('hydreq.editor.rightPaneWidth')||'0',10);
        if (w && w>240){ rightPane.style.flex = '0 0 auto'; rightPane.style.width = w+'px'; }
      } catch{}
      let dragging=false, startX=0, startW=0;
      const onMove=(e)=>{
        if(!dragging) return; const dx = e.clientX - startX; const nw = Math.max(300, startW - dx); rightPane.style.flex='0 0 auto'; rightPane.style.width = nw + 'px'; };
      const onUp=()=>{ if(!dragging) return; dragging=false; splitter.classList.remove('dragging'); try{ localStorage.setItem('hydreq.editor.rightPaneWidth', String(parseInt(rightPane.getBoundingClientRect().width,10)||0)); }catch{} window.removeEventListener('mousemove', onMove); window.removeEventListener('mouseup', onUp); };
      splitter.addEventListener('mousedown', (e)=>{ dragging=true; splitter.classList.add('dragging'); startX=e.clientX; startW=rightPane.getBoundingClientRect().width; window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp); });
      splitter.addEventListener('dblclick', ()=>{ rightPane.style.flex='0 1 30%'; rightPane.style.width=''; try{ localStorage.removeItem('hydreq.editor.rightPaneWidth'); }catch{} });
    })();

    // Density toggle: comfortable vs compact
    try {
      const pref = localStorage.getItem('hydreq.editor.density') || 'compact';
      if (pref === 'comfortable') { densityToggle.checked = true; editorRoot.classList.add('comfortable'); }
    } catch {}
    if (densityToggle) {
      densityToggle.addEventListener('change', ()=>{
        const comfy = densityToggle.checked;
        if (comfy) editorRoot.classList.add('comfortable'); else editorRoot.classList.remove('comfortable');
        try { localStorage.setItem('hydreq.editor.density', comfy ? 'comfortable' : 'compact'); } catch {}
      });
    }

    function kvTable(container, obj, onChange){
      const c = (typeof container === 'string') ? modal.querySelector(container) : container;
      c.innerHTML = '';
      const table = document.createElement('div');
      const addRow = (k='', v='')=>{
        const row = document.createElement('div'); row.className = 'ed-grid-1-1-auto'; row.style.marginBottom='6px';
        const ki = document.createElement('input'); ki.type='text'; ki.value=k; const vi=document.createElement('input'); vi.type='text'; vi.value=v;
        if (onChange){ ['input','change','blur'].forEach(ev=>{ ki.addEventListener(ev, onChange); vi.addEventListener(ev, onChange); }); }
        const del = document.createElement('button'); del.textContent='×'; del.title='Remove'; del.onclick = ()=>{ row.remove(); if (onChange) onChange(); };
        row.appendChild(ki); row.appendChild(vi); row.appendChild(del);
        table.appendChild(row);
      };
      // populate
      if (obj){ Object.keys(obj).forEach(k=> addRow(k, obj[k])); }
      const add = document.createElement('button'); add.textContent='Add'; add.onclick = ()=> { addRow(); if (onChange) onChange(); };
      c.appendChild(table); c.appendChild(add);
      return ()=>{
        const rows = Array.from(table.children);
        const out = {};
        rows.forEach(row=>{
          const inputs = row.querySelectorAll('input');
          if (inputs.length>=2){ const k=inputs[0].value.trim(); const v=inputs[1].value; if (k) out[k]=v; }
        });
        return out;
      };
    }

    function listTable(container, arr, onChange){
      const c = (typeof container === 'string') ? modal.querySelector(container) : container;
      c.innerHTML = '';
      const table = document.createElement('div');
      const addRow = (v='')=>{
        const row = document.createElement('div'); row.className = 'ed-grid-1-auto'; row.style.marginBottom='6px';
        const vi=document.createElement('input'); vi.type='text'; vi.value=v;
        if (onChange){ ['input','change','blur'].forEach(ev=> vi.addEventListener(ev, onChange)); }
        const del = document.createElement('button'); del.textContent='×'; del.title='Remove'; del.onclick = ()=>{ row.remove(); if (onChange) onChange(); };
        row.appendChild(vi); row.appendChild(del);
        table.appendChild(row);
      };
      if (Array.isArray(arr)) arr.forEach(v=> addRow(v));
      const add = document.createElement('button'); add.textContent='Add'; add.onclick = ()=> { addRow(); if (onChange) onChange(); };
      c.appendChild(table); c.appendChild(add);
      return ()=>{
        const rows = Array.from(table.children);
        const out = [];
        rows.forEach(row=>{ const inp = row.querySelector('input'); if (inp){ const v = inp.value; if (v!=='' && v!=null) out.push(v); }});
        return out;
      };
    }

    function mapTable(container, obj, valuePlaceholder='value', onChange){
      // Like kvTable, but for arbitrary value types (free text) and returns map[string]string-like
      return kvTable(container, obj||{}, onChange);
    }

  function hookList(container, hooks, options, onChange){
      const c = (typeof container==='string') ? modal.querySelector(container) : container;
      c.innerHTML = '';
      const list = document.createElement('div'); c.appendChild(list);
      const empty = document.createElement('div'); empty.className='dim'; empty.style.margin='6px 0'; empty.textContent = 'No hooks yet. Pick a mode, then Add.'; c.appendChild(empty);
      const actions = document.createElement('div'); actions.className='ed-row-6'; actions.style.marginTop='6px';
      const sel = document.createElement('select'); sel.className='select select-xs'; sel.innerHTML = '<option value="http">HTTP</option><option value="sql">SQL</option><option value="js">JS</option><option value="empty">Empty</option>';
      const add = document.createElement('button'); add.textContent='Add'; add.className='btn btn-xs'; add.title='Add hook';
      add.onclick = ()=>{
        const v = sel.value;
        if (v==='http') addRow({ __mode:'http', request: { method:'GET', url:'', headers:{}, query:{}, body:'' } });
        else if (v==='sql') addRow({ __mode:'sql', sql: { driver:'', dsn:'', query:'', extract:{} } });
        else if (v==='js') addRow({ __mode:'js', js: { code:'' } });
        else addRow({ __mode:'empty' });
        try{ if (onChange) onChange(); }catch{}
      };
      actions.appendChild(sel); actions.appendChild(add); c.appendChild(actions);

      function addRow(h){
        const row = document.createElement('div'); row.style.border='1px solid var(--bd)'; row.style.borderRadius='6px'; row.style.marginBottom='8px';
        // mode
  const mode = h && h.__mode ? h.__mode : (h && h.sql ? 'sql' : (h && h.request ? 'http' : (h && h.js ? 'js' : 'empty')));
        row._mode = mode;
        // header
        const header = document.createElement('div'); header.className='ed-row-6 ed-ai-center'; header.style.padding='6px 8px'; header.style.background='var(--pill)'; header.style.borderBottom='1px solid var(--bd)';
        const toggle = document.createElement('button'); toggle.textContent='▾'; toggle.className='btn btn-ghost btn-xs'; toggle.style.width='24px';
        const nameI = document.createElement('input'); nameI.className='hk_name'; nameI.type='text'; nameI.placeholder='hook name'; nameI.value=h?.name||''; nameI.style.flex='1';
  const badge = document.createElement('span'); badge.className='badge hk_type'; badge.textContent = (mode==='http'?'HTTP':(mode==='sql'?'SQL':(mode==='js'?'JS':'·')));
        const runBtn = document.createElement('button'); runBtn.className='btn btn-xs hk_run'; runBtn.textContent='Run';
        const convertBtn = document.createElement('button'); convertBtn.className='btn btn-xs'; convertBtn.textContent='Convert…'; convertBtn.title='Switch mode';
        const delBtn = document.createElement('button'); delBtn.className='btn btn-xs hk_del'; delBtn.textContent='×'; delBtn.title='Remove';
        header.appendChild(toggle); header.appendChild(nameI); header.appendChild(badge); header.appendChild(runBtn); header.appendChild(convertBtn); header.appendChild(delBtn);
        row.appendChild(header);
        const body = document.createElement('div'); body.style.padding='8px'; row.appendChild(body);
        // grid
        const grid = document.createElement('div'); grid.className='ed-grid-2-140'; body.appendChild(grid);
        // Vars
        const varsLabel = document.createElement('label'); varsLabel.textContent='Vars'; const varsDiv=document.createElement('div'); varsDiv.className='hk_vars'; grid.appendChild(varsLabel); grid.appendChild(varsDiv);
  const varsGet = kvTable(varsDiv, h?.vars||{}, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
        // HTTP section
        const httpLabel = document.createElement('label'); httpLabel.textContent='HTTP'; const httpC = document.createElement('div'); httpC.className='hk_http'; grid.appendChild(httpLabel); grid.appendChild(httpC);
        const http = h?.request||{}; const hg = document.createElement('div'); hg.style.display='grid'; hg.style.gridTemplateColumns='120px 1fr'; hg.style.gap='6px';
        hg.innerHTML = `
          <label>Method</label>
          <select class="hk_method select select-xs"></select>
          <label>URL</label><input class="hk_url" type="text" value="${http.url||''}">
          <label>Headers</label><div class="hk_headers"></div>
          <label>Query</label><div class="hk_query"></div>
          <label>Body</label><textarea class="hk_body" style="height:80px"></textarea>`;
        httpC.appendChild(hg);
        // populate method options safely
        (function(){
          const sel = hg.querySelector('.hk_method');
          const cur = String((http.method||'').toUpperCase());
          ['GET','POST','PUT','PATCH','DELETE','HEAD','OPTIONS'].forEach(m=>{
            const o=document.createElement('option'); o.value=m; o.textContent=m; if (cur===m) o.selected=true; sel.appendChild(o);
          });
        })();
  const hkHeadGet = kvTable(hg.querySelector('.hk_headers'), http.headers||{}, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
  const hkQueryGet = kvTable(hg.querySelector('.hk_query'), http.query||{}, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
        const bodyEl = hg.querySelector('.hk_body'); try { bodyEl.value = (http.body && typeof http.body==='object')? JSON.stringify(http.body,null,2):(http.body||''); } catch { bodyEl.value = http.body||''; }
        // JS section
        const jsLabel = document.createElement('label'); jsLabel.textContent='JS'; const jsC = document.createElement('div'); jsC.className='hk_js'; grid.appendChild(jsLabel); grid.appendChild(jsC);
        const js = h?.js||{}; const jsg = document.createElement('div'); jsg.style.display='grid'; jsg.style.gridTemplateColumns='120px 1fr'; jsg.style.gap='6px';
        jsg.innerHTML = `
          <label>Code</label><textarea class="hk_js_code" style="height:120px; font-family: 'Courier New', monospace; font-size: 12px;" placeholder="JavaScript code...">${js.code||''}</textarea>`;
        jsC.appendChild(jsg);
        // SQL section
        const sqlLabel = document.createElement('label'); sqlLabel.textContent='SQL'; const sqlC = document.createElement('div'); sqlC.className='hk_sql'; grid.appendChild(sqlLabel); grid.appendChild(sqlC);
        const sql = h?.sql||{}; const sg = document.createElement('div'); sg.style.display='grid'; sg.style.gridTemplateColumns='120px 1fr'; sg.style.gap='6px';
        sg.innerHTML = `
          <label>Driver</label>
          <select class="hk_driver select select-xs"><option value="">(select)</option><option value="sqlite" ${sql.driver==='sqlite'?'selected':''}>sqlite</option><option value="pgx" ${sql.driver==='pgx'?'selected':''}>pgx (Postgres)</option><option value="sqlserver" ${sql.driver==='sqlserver'?'selected':''}>sqlserver (SQL Server)</option></select>
          <label>DSN</label>
          <div style="display:flex;gap:6px;align-items:center"><input class="hk_dsn" type="password" value="${sql.dsn||''}" style="flex:1" placeholder="file:./qa.sqlite?cache=shared"><button class="hk_toggle_dsn" type="button" title="Show/Hide">👁</button><button class="hk_fill_dsn" type="button" title="Fill template">Use template</button></div>
          <label>Query</label><textarea class="hk_querytxt" style="height:80px">${sql.query||''}</textarea>
          <label>Extract</label><div class="hk_sqlextract"></div>`;
        sqlC.appendChild(sg);
        const toggleBtn = sg.querySelector('.hk_toggle_dsn'); const dsnInput = sg.querySelector('.hk_dsn'); toggleBtn.onclick = ()=>{ dsnInput.type = (dsnInput.type==='password'?'text':'password'); };
  const hkSQLExtractGet = kvTable(sg.querySelector('.hk_sqlextract'), sql.extract||{}, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
        const driverEl = sg.querySelector('.hk_driver'); const dsnEl = sg.querySelector('.hk_dsn'); const dsnPH = { sqlite: 'file:./qa.sqlite?cache=shared', pgx: 'postgres://user:pass@localhost:5432/db?sslmode=disable', sqlserver: 'sqlserver://sa:Your_password123@localhost:1433?database=master' };
        function refreshDsnPH(){ const v=(driverEl.value||'').trim(); dsnEl.placeholder = dsnPH[v]||''; }
        driverEl.addEventListener('change', refreshDsnPH); refreshDsnPH();
        const fillBtn = sg.querySelector('.hk_fill_dsn'); if (fillBtn) fillBtn.onclick = ()=>{ const v=(driverEl.value||'').trim(); const tmpl=dsnPH[v]||''; if(!tmpl) return; if(!dsnEl.value || confirm('Overwrite DSN with template?')) dsnEl.value = tmpl; };
        // enforce mode visibility
        function applyMode(){
          const showHTTP = (row._mode==='http');
          const showSQL = (row._mode==='sql');
          const showJS = (row._mode==='js');
          httpLabel.style.display = showHTTP?'':'none'; httpC.style.display = showHTTP?'':'none';
          sqlLabel.style.display = showSQL?'':'none'; sqlC.style.display = showSQL?'':'none';
          jsLabel.style.display = showJS?'':'none'; jsC.style.display = showJS?'':'none';
          badge.textContent = (row._mode==='http'?'HTTP':(row._mode==='sql'?'SQL':(row._mode==='js'?'JS':'·')));
        }
        applyMode();
        // header collapse
        toggle.onclick = ()=>{ const open = body.style.display !== 'none'; body.style.display = open?'none':'block'; toggle.textContent = open?'▸':'▾'; };
        // badge color and updates
        function refreshBadge(){
          badge.classList.remove('badge-info','badge-secondary','badge-success');
          if (row._mode==='http') badge.classList.add('badge-info');
          else if (row._mode==='sql') badge.classList.add('badge-secondary');
          else if (row._mode==='js') badge.classList.add('badge-success');
        }
        refreshBadge();
        // convert mode
        convertBtn.onclick = ()=>{ const to = prompt('Convert to mode: http, sql, or js?', row._mode); const v=(to||'').trim().toLowerCase(); if (v!=='http' && v!=='sql' && v!=='js') return; if(!confirm('Switch mode to '+v+'?')) return; row._mode=v; applyMode(); refreshBadge(); };
        // delete
        delBtn.onclick = ()=> row.remove();
        // output area
        const out = document.createElement('div'); out.className='log'; out.style.marginTop='8px'; body.appendChild(out);
        // run
        runBtn.onclick = async ()=>{
          const req={ method: (hg.querySelector('.hk_method').value||'').toUpperCase(), url: hg.querySelector('.hk_url').value||'', headers: hkHeadGet(), query: hkQueryGet(), body: (function(txt){ try{ return txt?JSON.parse(txt):null }catch{return txt} })(bodyEl.value.trim()) };
          const sql={ driver: driverEl.value||'', dsn: dsnEl.value||'', query: (sg.querySelector('.hk_querytxt').value||''), extract: hkSQLExtractGet() };
          const js = { code: (jsg.querySelector('.hk_js_code').value || '') };
          const name = nameI.value||''; const vars = varsGet(); const payload = { name, vars };
          if (row._mode==='http') payload.request = req; else if (row._mode==='sql') payload.sql = sql; else if (row._mode==='js') payload.js = js;
          const env = (function(){ const env = {}; const lines=(document.getElementById('env_kv').value||'').split(/\n/); for(const line of lines){ const s=line.trim(); if(!s) return; const eq=s.indexOf('='); if(eq>0){ env[s.slice(0,eq).trim()] = s.slice(eq+1).trim(); } } return env; })();
          const scope = (options && options.scope) || 'suitePre';
          out.innerHTML = 'Running...';
          let res; try { res = await fetch('/api/editor/hookrun', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ parsed: working, scope, testIndex: selIndex, hook: payload, env })}); } catch(e){ out.textContent = 'Network error'; return; }
          if (!res.ok){ const t=await res.text().catch(()=> ''); out.textContent = 'Run failed: ' + t; return; }
          const r = await res.json(); const icon = r.status==='passed'?'✓':(r.status==='failed'?'✗':'-'); const hdr = document.createElement('div'); hdr.style.fontWeight='600'; hdr.textContent = `${icon} hook ${r.name||''} (${r.durationMs||0} ms)`; out.innerHTML=''; out.appendChild(hdr);
          if (Array.isArray(r.messages) && r.messages.length){ const pre=document.createElement('pre'); pre.className=(r.status==='failed'?'fail':(r.status==='skipped'?'skip':'ok')); pre.textContent = r.messages.join('\n'); out.appendChild(pre); }
          if (r.vars && Object.keys(r.vars).length){ const det=document.createElement('details'); const sum=document.createElement('summary'); sum.textContent='vars'; det.appendChild(sum); const pre=document.createElement('pre'); pre.textContent = JSON.stringify(r.vars,null,2); det.appendChild(pre); out.appendChild(det); }
        };
        // getter
        row._get = ()=>{ const name = nameI.value||''; const vars = varsGet(); const out = { name, vars }; if (row._mode==='http'){ const req={ method: (hg.querySelector('.hk_method').value||'').toUpperCase(), url: hg.querySelector('.hk_url').value||'', headers: hkHeadGet(), query: hkQueryGet(), body: (function(txt){ try{ return txt?JSON.parse(txt):null }catch{return txt} })(bodyEl.value.trim()) }; if (req.method||req.url||Object.keys(req.headers||{}).length||Object.keys(req.query||{}).length||bodyEl.value.trim()) out.request=req; } else if (row._mode==='sql'){ const sql={ driver: driverEl.value||'', dsn: dsnEl.value||'', query: (sg.querySelector('.hk_querytxt').value||''), extract: hkSQLExtractGet() }; if (sql.driver||sql.dsn||sql.query||Object.keys(sql.extract||{}).length) out.sql=sql; } else if (row._mode==='js'){ const js={ code: (jsg.querySelector('.hk_js_code').value || '') }; if (js.code.trim()) out.js=js; } return out; };
        list.appendChild(row);
        if (list.children.length > 0) empty.style.display = 'none';
        // propagate generic input/change events from any inputs inside the row
        if (onChange){
          row.addEventListener('input', ()=>{ try{ onChange(); }catch{} }, true);
          row.addEventListener('change', ()=>{ try{ onChange(); }catch{} }, true);
        }
        // ensure delete triggers change
        const delBtnLocal = header.querySelector('.hk_del');
        if (delBtnLocal){
          const orig = delBtnLocal.onclick;
          delBtnLocal.onclick = ()=>{ if (typeof orig === 'function') orig(); try{ if (onChange) onChange(); }catch{} };
        }
        // ensure convert triggers change
        const conv = header.querySelector('button[title="Switch mode"]');
        if (conv){ const origc = conv.onclick; conv.onclick = ()=>{ if (typeof origc === 'function') origc(); try{ if (onChange) onChange(); }catch{} }; }
        return row._get;
      }
      // populate
      if (Array.isArray(hooks)) hooks.forEach(h=> addRow(h));
      return ()=> Array.from(list.children).map(r=> r._get ? r._get() : null).filter(Boolean);
    }

    function renderTests(){
      const list = modal.querySelector('#ed_tests');
      list.innerHTML='';
      if (selIndex >= working.tests.length) selIndex = Math.max(0, working.tests.length-1);
      (working.tests||[]).forEach((t, i)=>{
  const div = document.createElement('div'); div.className='ed-row-8 ed-ai-center'; div.style.padding='6px 8px'; div.style.cursor='pointer'; div.style.justifyContent='space-between'; if (i===selIndex){ div.style.background='var(--li-sel)'; }
  const label = document.createElement('span');
  const fullName = (t.name||`test ${i+1}`);
  // Truncate long names for display; show full name in tooltip
  const maxLen = 36;
  const displayName = (fullName.length > maxLen) ? (fullName.slice(0, maxLen-1) + '…') : fullName;
  label.textContent = displayName;
  label.title = fullName;
    // Rename via pencil button (opens inline editor)
    label.style.userSelect = 'text';
    const editBtn = document.createElement('button');
    editBtn.className = 'btn btn-ghost btn-xs';
    editBtn.title = 'Rename test';
    editBtn.innerHTML = '✎';
    editBtn.onclick = (ev)=>{
      ev.stopPropagation();
      const cur = working.tests[i] || {};
      const initial = cur.name || `test ${i+1}`;
      const inp = document.createElement('input'); inp.type='text'; inp.value = initial; inp.style.width = '100%'; inp.style.boxSizing='border-box';
      // Replace label with input
      label.replaceWith(inp);
      inp.focus(); inp.select();
      const commit = ()=>{
        const v = (inp.value||'').trim();
        if (!working.tests[i]) working.tests[i] = {};
        working.tests[i].name = v || initial;
        // Restore label
        const newFull = working.tests[i].name || initial;
        label.textContent = (newFull.length>maxLen) ? (newFull.slice(0,maxLen-1)+'…') : newFull;
        label.title = newFull;
        inp.replaceWith(label);
        try{ sync(); serializeWorkingToYamlImmediate().catch(()=>{}); }catch{};
        renderTests(); renderForm();
      };
      inp.onblur = commit;
      inp.onkeydown = (ke)=>{ if (ke.key === 'Enter') { commit(); } else if (ke.key === 'Escape') { inp.replaceWith(label); } };
    };
    const right = document.createElement('span'); right.className='ed-row-6 ed-ai-center';
    const runDepsBtn = document.createElement('button'); runDepsBtn.className='btn btn-ghost btn-xs'; runDepsBtn.title='Run with dependencies'; runDepsBtn.textContent='▶ deps';
    const badge = document.createElement('span'); badge.className='pill';
        (function(){
          const k = i + ':' + (t.name||('test '+(i+1)));
          const r = testRunCache.get(k);
          if (!r) { badge.textContent='•'; badge.style.opacity='.5'; }
          else {
            badge.textContent = r.status==='passed'?'✓':(r.status==='failed'?'✗':'-');
            badge.style.background = r.status==='passed'?'#e8f5e9':(r.status==='failed'?'#fde2e1':'var(--pill)');
          }
        })();
      right.appendChild(runDepsBtn); right.appendChild(badge);
      // place edit button next to label
      const leftWrap = document.createElement('span'); leftWrap.style.display='flex'; leftWrap.style.gap='6px'; leftWrap.style.alignItems='center';
      leftWrap.appendChild(label);
      leftWrap.appendChild(editBtn);
      div.appendChild(leftWrap);
      div.appendChild(right);
  div.onclick = (ev)=>{ if (ev.target===runDepsBtn) return; selIndex=i; renderTests(); renderForm(); renderQuickRunForSelection(); try{ sync(); serializeWorkingToYamlImmediate().catch(()=>{}); }catch{} };
        runDepsBtn.onclick = async (ev)=>{
          ev.stopPropagation();
          try{ if (typeof sync === 'function') sync(); }catch{}
          const env = (function(){ const env = {}; const lines=(document.getElementById('env_kv').value||'').split(/\n/); for(const line of lines){ const s=line.trim(); if(!s) return; const eq=s.indexOf('='); if(eq>0){ env[s.slice(0,eq).trim()] = s.slice(eq+1).trim(); } } return env; })();
          const vres = await fetch('/api/editor/validate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ parsed: working })}); if (!vres.ok){ alert('Validation failed'); return; }
          const v = await vres.json(); if (!v.parsed){ alert('Cannot run: content did not parse'); return; }
          const body = { parsed: v.parsed, testIndex: i, env, runAll: false, includeDeps: true };
          const res = await fetch('/api/editor/testrun', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
          if (!res.ok){ const t=await res.text().catch(()=> ''); alert('Run failed: '+t); return; }
          const r = await res.json(); if (Array.isArray(r.cases)){ for (const c of r.cases){ const idx = (working.tests||[]).findIndex(tt=> tt.name===c.name); if (idx>=0){ const k = idx+':'+(c.name||('test '+(idx+1))); testRunCache.set(k, c); } } }
          try{ localStorage.setItem(LS_KEY(path), JSON.stringify(Object.fromEntries(testRunCache.entries()))); }catch{}
          renderTests(); setQuickRunBox(r); const qrBox = modal.querySelector('#ed_quickrun_box'); if (qrBox) qrBox.open = true;
        };
        list.appendChild(div);
      });
      // Attach add/delete handlers
      const addBtn = modal.querySelector('#ed_add_test');
      const delBtn = modal.querySelector('#ed_del_test');
  addBtn.onclick = ()=>{
    const defaultName = `test ${working.tests.length+1}`;
    const name = prompt('Enter test name:', defaultName);
    const finalName = (name && name.trim()) ? name.trim() : defaultName;
    working.tests.push({ name: finalName, request:{ method:'GET', url:'' }, assert:{ status:200 } });
    selIndex = working.tests.length-1; renderTests(); renderForm(); try{ sync(); serializeWorkingToYamlImmediate().catch(()=>{}); }catch{} };
  delBtn.onclick = ()=>{ if (working.tests.length===0) return; if (!confirm('Delete selected test?')) return; working.tests.splice(selIndex,1); selIndex = Math.max(0, selIndex-1); renderTests(); if (working.tests.length) renderForm(); try{ sync(); serializeWorkingToYamlImmediate().catch(()=>{}); }catch{} };
    }

  // hoisted getters/elements used by sync() so Visual->YAML mirroring works
  let suiteVarsGet, getPreSuite, getPostSuite, headersGet, queryGet, bodyEl, aHeadGet, aEqGet, aContGet, aBodyGet, extractGet, matrixGet, getPreHooks, getPostHooks, oapiSel;

  function renderForm(){
      if (!working.tests.length){
        const f = modal.querySelector('#ed_req_form'); if (f) f.querySelectorAll('input,select,textarea,button').forEach(el=>{ if (el.id!=='ed_add_test') el.disabled = true; });
        return;
      } else {
        const f = modal.querySelector('#ed_req_form'); if (f) f.querySelectorAll('input,select,textarea,button').forEach(el=> el.disabled = false);
      }
      // Suite fields
      modal.querySelector('#ed_suite_name').value = working.name || '';
      modal.querySelector('#ed_suite_baseurl').value = working.baseUrl || '';
  suiteVarsGet = kvTable('#ed_suite_vars', working.vars||{}, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
  // Suite hooks editors (assign to hoisted getters so sync() can call them)
  getPreSuite = hookList('#ed_suite_presuite', (working.preSuite||[]), { scope: 'suitePre' }, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
  getPostSuite = hookList('#ed_suite_postsuite', (working.postSuite||[]), { scope: 'suitePost' }, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
    const t = (working.tests && working.tests[selIndex]) || {};
    const req = t.request || {};
  modal.querySelector('#ed_method').value = (req.method||'GET').toUpperCase();
  modal.querySelector('#ed_url').value = req.url || '';
  // Test name (visual)
  modal.querySelector('#ed_test_name').value = t.name || '';
    modal.querySelector('#ed_timeout').value = t.timeoutMs || '';
  headersGet = kvTable('#ed_headers', req.headers||{}, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} });
  queryGet = kvTable('#ed_query', req.query||{}, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} });
    // Body: show as JSON if object, otherwise as string
    bodyEl = modal.querySelector('#ed_body');
      try { bodyEl.value = (req.body && typeof req.body === 'object') ? JSON.stringify(req.body, null, 2) : (req.body || ''); } catch{ bodyEl.value = req.body || ''; }
  // Assertions
      const as = t.assert || {};
      modal.querySelector('#ed_assert_status').value = (as.status||0);
  aHeadGet = kvTable('#ed_assert_headerEquals', as.headerEquals||{}, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} });
  aEqGet = mapTable('#ed_assert_jsonEquals', as.jsonEquals||{}, 'value', ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} });
  aContGet = mapTable('#ed_assert_jsonContains', as.jsonContains||{}, 'value', ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} });
  aBodyGet = listTable('#ed_assert_bodyContains', as.bodyContains||[], ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} });
      modal.querySelector('#ed_assert_maxDuration').value = (as.maxDurationMs||'');
      // Extract
  const extractC = modal.querySelector('#ed_extract');
      const buildExtract = ()=>{
        extractC.innerHTML='';
        const table = document.createElement('div');
        const addRow = (name='', jsonPath='')=>{
          const row = document.createElement('div'); row.className='ed-grid-1-1-auto'; row.style.marginBottom='6px';
          const nameI = document.createElement('input'); nameI.placeholder='var name'; nameI.value=name;
          const pathI = document.createElement('input'); pathI.placeholder='json.id'; pathI.value=jsonPath;
          ['input','change','blur'].forEach(ev=>{ nameI.addEventListener(ev, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} }); pathI.addEventListener(ev, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} }); });
          const del = document.createElement('button'); del.textContent='×'; del.title='Remove'; del.onclick=()=> { row.remove(); try{ sync(); syncYamlPreviewFromVisual(); }catch{} };
          row.appendChild(nameI); row.appendChild(pathI); row.appendChild(del); table.appendChild(row);
        };
        const ex = t.extract || {};
        Object.keys(ex).forEach(k=> addRow(k, (ex[k] && ex[k].jsonPath)||''));
        const add = document.createElement('button'); add.textContent='Add'; add.onclick = ()=> { addRow(); try{ sync(); syncYamlPreviewFromVisual(); }catch{} };
        extractC.appendChild(table); extractC.appendChild(add);
        return ()=>{
          const rows = Array.from(table.children);
          const out = {};
          rows.forEach(row=>{
            const inputs = row.querySelectorAll('input');
            if (inputs.length>=2){ const name = (inputs[0].value||'').trim(); const jp = (inputs[1].value||'').trim(); if (name){ out[name] = { jsonPath: jp }; } }
          });
          return out;
        };
      };
  extractGet = buildExtract();
      // Flow & meta
      modal.querySelector('#ed_skip').checked = !!t.skip;
      modal.querySelector('#ed_only').checked = !!t.only;
      modal.querySelector('#ed_stage').value = (t.stage||0);
      modal.querySelector('#ed_tags').value = Array.isArray(t.tags)? t.tags.join(', ') : '';
      modal.querySelector('#ed_depends').value = Array.isArray(t.dependsOn)? t.dependsOn.join(', ') : '';
      // Retry
      const hasRetry = !!t.retry;
      modal.querySelector('#ed_retry_enable').checked = hasRetry;
      modal.querySelector('#ed_retry_max').value = hasRetry?(t.retry.max||0):0;
      modal.querySelector('#ed_retry_backoff').value = hasRetry?(t.retry.backoffMs||0):0;
      modal.querySelector('#ed_retry_jitter').value = hasRetry?(t.retry.jitterPct||0):0;
  // Matrix
  const matrixC = modal.querySelector('#ed_matrix');
      const buildMatrix = ()=>{
        matrixC.innerHTML='';
        const table = document.createElement('div');
        const addRow = (k='', vals=[])=>{
          const row = document.createElement('div'); row.className='ed-grid-1-1-auto'; row.style.marginBottom='6px';
          const ki=document.createElement('input'); ki.placeholder='var'; ki.value=k;
          const vi=document.createElement('input'); vi.placeholder='v1, v2, v3'; vi.value=(Array.isArray(vals)?vals.join(', '):'');
          ['input','change','blur'].forEach(ev=>{ ki.addEventListener(ev, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} }); vi.addEventListener(ev, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); }catch{} }); });
          const del=document.createElement('button'); del.textContent='×'; del.title='Remove'; del.onclick=()=> { row.remove(); try{ sync(); syncYamlPreviewFromVisual(); }catch{} };
          row.appendChild(ki); row.appendChild(vi); row.appendChild(del); table.appendChild(row);
        };
        const mx = t.matrix || {};
        Object.keys(mx).forEach(k=> addRow(k, mx[k]||[]));
        const add = document.createElement('button'); add.textContent='Add'; add.onclick = ()=> { addRow(); try{ sync(); syncYamlPreviewFromVisual(); }catch{} };
        matrixC.appendChild(table); matrixC.appendChild(add);
        return ()=>{
          const rows = Array.from(table.children);
          const out = {};
          rows.forEach(row=>{ const inputs=row.querySelectorAll('input'); if (inputs.length>=2){ const k=inputs[0].value.trim(); const vs=(inputs[1].value||'').split(',').map(s=>s.trim()).filter(Boolean); if (k) out[k]=vs; }});
          return out;
        };
      };
  matrixGet = buildMatrix();
    // Test hooks editors (initialize once per render)
  getPreHooks = hookList('#ed_test_prehooks', (t.pre||[]), { scope: 'testPre' }, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
  getPostHooks = hookList('#ed_test_posthooks', (t.post||[]), { scope: 'testPost' }, ()=>{ try{ sync(); syncYamlPreviewFromVisual(); markDirty(); }catch{} });
  // OpenAPI
  oapiSel = modal.querySelector('#ed_oapi_enabled');
      const oapiState = t.openApi && typeof t.openApi.enabled === 'boolean' ? String(t.openApi.enabled) : 'inherit';
      oapiSel.value = oapiState;
      // Attach change handlers to update working model when leaving form (simple approach)
      async function updateEnvPresence(){
        const names = [];
        const be = (modal.querySelector('#ed_auth_bearer').value||'').trim();
        const ba = (modal.querySelector('#ed_auth_basic').value||'').trim();
        if (be) names.push(be); if (ba) names.push(ba);
        if (names.length === 0) {
          // nothing to check
          const setStatus = (el, ok)=>{ el.textContent = ok? 'env OK' : 'missing'; el.style.background = ok? 'var(--pill)' : '#fde2e1'; };
          setStatus(modal.querySelector('#ed_auth_bearer_status'), false);
          setStatus(modal.querySelector('#ed_auth_basic_status'), false);
          return;
        }
        let res = null;
        try { res = await fetch('/api/editor/envcheck', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ names })}); } catch {}
        const present = res && res.ok ? (await res.json()).present : {};
        const setStatus = (el, ok)=>{ el.textContent = ok? 'env OK' : 'missing'; el.style.background = ok? 'var(--pill)' : '#fde2e1'; };
        setStatus(modal.querySelector('#ed_auth_bearer_status'), !!present[be]);
        setStatus(modal.querySelector('#ed_auth_basic_status'), !!present[ba]);
      }
      function updateAuthPreview(){
        const be = (modal.querySelector('#ed_auth_bearer').value||'').trim();
        const ba = (modal.querySelector('#ed_auth_basic').value||'').trim();
        let txt = '(none)';
        if (be) txt = 'Authorization: Bearer ${'+be+'}';
        else if (ba) txt = 'Authorization: Basic ${'+ba+'}';
        modal.querySelector('#ed_auth_preview').textContent = txt;
      }
  const sync = ()=>{
        // Suite sync
        working.name = (modal.querySelector('#ed_suite_name').value||'');
        working.baseUrl = (modal.querySelector('#ed_suite_baseurl').value||'');
        working.vars = suiteVarsGet();
        const be = (modal.querySelector('#ed_auth_bearer').value||'').trim();
        const ba = (modal.querySelector('#ed_auth_basic').value||'').trim();
        working.auth = (be || ba) ? { bearerEnv: be, basicEnv: ba } : null;
        working.preSuite = getPreSuite();
        working.postSuite = getPostSuite();
        updateAuthPreview();
        updateEnvPresence();
        // Test sync
        const cur = (working.tests && working.tests[selIndex]) || {};
        cur.request = cur.request || {};
        cur.request.method = modal.querySelector('#ed_method').value || 'GET';
        cur.request.url = modal.querySelector('#ed_url').value || '';
        const to = parseInt(modal.querySelector('#ed_timeout').value, 10); cur.timeoutMs = isNaN(to)?0:to;
        cur.request.headers = headersGet();
        cur.request.query = queryGet();
  // Test name (visual)
  cur.name = (modal.querySelector('#ed_test_name').value||'').trim();
        const txt = bodyEl.value.trim();
        if (!txt){ cur.request.body = null; }
        else {
          try { cur.request.body = JSON.parse(txt); }
          catch { cur.request.body = txt; }
        }
        // Assertions
        const as = cur.assert || {};
        const st = parseInt(modal.querySelector('#ed_assert_status').value, 10); as.status = isNaN(st)?0:st;
        as.headerEquals = aHeadGet();
        as.jsonEquals = aEqGet();
        as.jsonContains = aContGet();
        as.bodyContains = aBodyGet();
        const md = parseInt(modal.querySelector('#ed_assert_maxDuration').value, 10); as.maxDurationMs = isNaN(md)?0:md;
        cur.assert = as;
        // Extract
        cur.extract = extractGet();
        // Flow
        cur.skip = !!modal.querySelector('#ed_skip').checked;
        cur.only = !!modal.querySelector('#ed_only').checked;
        const stg = parseInt(modal.querySelector('#ed_stage').value, 10); cur.stage = isNaN(stg)?0:stg;
        const tags = modal.querySelector('#ed_tags').value; cur.tags = (tags? tags.split(',').map(s=>s.trim()).filter(Boolean):[]);
        const deps = modal.querySelector('#ed_depends').value; cur.dependsOn = (deps? deps.split(',').map(s=>s.trim()).filter(Boolean):[]);
        // Retry
        if (modal.querySelector('#ed_retry_enable').checked){
          cur.retry = cur.retry || {};
          cur.retry.max = parseInt(modal.querySelector('#ed_retry_max').value,10)||0;
          cur.retry.backoffMs = parseInt(modal.querySelector('#ed_retry_backoff').value,10)||0;
          cur.retry.jitterPct = parseInt(modal.querySelector('#ed_retry_jitter').value,10)||0;
        } else {
          cur.retry = null;
        }
        // Matrix
        cur.matrix = matrixGet();
        // Hooks and OpenAPI
        cur.pre = getPreHooks();
        cur.post = getPostHooks();
        // OpenAPI
        const ov = oapiSel.value;
        if (ov==='inherit'){ cur.openApi = null; }
        else { cur.openApi = { enabled: (ov==='true') }; }
        // write back
        working.tests[selIndex] = cur;
  // Mirror YAML from Visual edits so YAML stays live-synced (force immediate serialization so Visual -> YAML is 2-way)
  try { serializeWorkingToYamlImmediate().catch(()=>{}); } catch {}
      };
      ['change','blur','input'].forEach(evt=>{
        modal.querySelector('#ed_suite_name').addEventListener(evt, sync);
        modal.querySelector('#ed_suite_baseurl').addEventListener(evt, sync);
        modal.querySelector('#ed_auth_bearer').addEventListener(evt, sync);
        modal.querySelector('#ed_auth_basic').addEventListener(evt, sync);
  modal.querySelector('#ed_method').addEventListener(evt, sync);
  modal.querySelector('#ed_url').addEventListener(evt, sync);
  modal.querySelector('#ed_test_name').addEventListener(evt, sync);
        modal.querySelector('#ed_timeout').addEventListener(evt, sync);
        bodyEl.addEventListener(evt, sync);
        modal.querySelector('#ed_assert_status').addEventListener(evt, sync);
        modal.querySelector('#ed_assert_maxDuration').addEventListener(evt, sync);
        modal.querySelector('#ed_skip').addEventListener(evt, sync);
        modal.querySelector('#ed_only').addEventListener(evt, sync);
        modal.querySelector('#ed_stage').addEventListener(evt, sync);
        modal.querySelector('#ed_tags').addEventListener(evt, sync);
        modal.querySelector('#ed_depends').addEventListener(evt, sync);
        modal.querySelector('#ed_retry_enable').addEventListener(evt, sync);
        modal.querySelector('#ed_retry_max').addEventListener(evt, sync);
        modal.querySelector('#ed_retry_backoff').addEventListener(evt, sync);
        modal.querySelector('#ed_retry_jitter').addEventListener(evt, sync);
        oapiSel.addEventListener(evt, sync);
        // dirty signals
  modal.querySelector('#ed_suite_name').addEventListener(evt, markDirty);
  modal.querySelector('#ed_suite_baseurl').addEventListener(evt, markDirty);
  modal.querySelector('#ed_auth_bearer').addEventListener(evt, markDirty);
  modal.querySelector('#ed_auth_basic').addEventListener(evt, markDirty);
  modal.querySelector('#ed_method').addEventListener(evt, markDirty);
  modal.querySelector('#ed_url').addEventListener(evt, markDirty);
  modal.querySelector('#ed_test_name').addEventListener(evt, markDirty);
  modal.querySelector('#ed_timeout').addEventListener(evt, markDirty);
  bodyEl.addEventListener(evt, markDirty);
  modal.querySelector('#ed_assert_status').addEventListener(evt, markDirty);
  modal.querySelector('#ed_assert_maxDuration').addEventListener(evt, markDirty);
  modal.querySelector('#ed_skip').addEventListener(evt, markDirty);
  modal.querySelector('#ed_only').addEventListener(evt, markDirty);
  modal.querySelector('#ed_stage').addEventListener(evt, markDirty);
  modal.querySelector('#ed_tags').addEventListener(evt, markDirty);
  modal.querySelector('#ed_depends').addEventListener(evt, markDirty);
  modal.querySelector('#ed_retry_enable').addEventListener(evt, markDirty);
  modal.querySelector('#ed_retry_max').addEventListener(evt, markDirty);
  modal.querySelector('#ed_retry_backoff').addEventListener(evt, markDirty);
  modal.querySelector('#ed_retry_jitter').addEventListener(evt, markDirty);
  oapiSel.addEventListener(evt, markDirty);
      });
    }

    renderTests();
    renderForm();
    // start live YAML validation and initial state
  ensureYamlEditor();
  // Normalize initial content by converting tabs to two spaces. Use the
  // inMemoryYaml (which may have been created from data.parsed) so newly
  // created suites get a prefilled YAML document.
  yamlEditor.setValue((inMemoryYaml || '').replace(/\t/g, '  '));
  yamlDirty = false;
  // initial parse/normalize is intentionally skipped; validation is performed on-demand by the user
  // (clicking the 'Validate' button). Keep the YAML as provided by the file.
  // keep YAML preview in sync when editing Visual (but only when YAML tab hidden)
    const cacheKey = ()=>{
      const t = (working.tests && working.tests[selIndex]) || {};
      return selIndex + ':' + (t.name||('test '+(selIndex+1)));
    };
    function setQuickRunBox(result){
      quickRunBox.innerHTML = '';
      if (!result){
        const empty = document.createElement('div'); empty.style.opacity='.8'; empty.textContent = 'No run yet for this test'; quickRunBox.appendChild(empty); return;
      }
      const icon = result.status==='passed'?'✓':(result.status==='failed'?'✗':'-');
      const header = `${icon} ${result.name||('test '+(selIndex+1))} (${result.durationMs||0} ms)`;
  const h = document.createElement('div'); h.style.fontWeight='600'; h.style.marginBottom='6px'; if (result.status==='failed'){ h.style.color='#ef4444'; } else if (result.status==='skipped'){ h.style.color='#f59e0b'; } else { h.style.color='#10b981'; } h.textContent = header; quickRunBox.appendChild(h);
      if (Array.isArray(result.messages) && result.messages.length){ const pre=document.createElement('pre'); pre.className = (result.status==='failed'?'fail':(result.status==='skipped'?'skip':'ok')); pre.textContent = result.messages.join('\n'); quickRunBox.appendChild(pre); }
    }
    function renderQuickRunForSelection(){
      const key = cacheKey();
      const r = testRunCache.get(key);
      setQuickRunBox(r || null);
      const qrBox = modal.querySelector('#ed_quickrun_box'); if (qrBox) qrBox.open = true;
    }
  // initial env presence/auth preview (no-op call removed); updateEnvPresence will call when needed
    const renderIssues = (arr, yamlPreview)=>{
      issuesEl.innerHTML = '';
      if (!arr || !arr.length){ issuesEl.textContent = 'No issues'; } else {
        arr.forEach(it=>{
          const sev = (it.severity||'error').toLowerCase();
          const cls = sev==='error' ? 'alert-error' : sev==='warning' ? 'alert-warning' : 'alert-success';
          const d=document.createElement('div'); d.style.marginBottom='6px';
          d.innerHTML = `<div class="alert ${cls}"><span><b>${(it.severity||'error').toUpperCase()}</b> — ${it.message||''}</span><div class=\"dim\">${it.path||''}</div></div>`;
          issuesEl.appendChild(d);
        });
      }
      if (yamlPreview){ const pre=document.createElement('pre'); pre.style.marginTop='8px'; pre.textContent = yamlPreview; issuesEl.appendChild(pre); }
      const copyBtn = modal.querySelector('#ed_copy_issues');
      if (copyBtn){
        copyBtn.onclick = async ()=>{
          try{
            const text = (arr||[]).map(it=>`[${(it.severity||'').toUpperCase()}] ${it.message||''} @ ${it.path||''}`).join('\n') + (yamlPreview? `\n\nYAML Preview:\n${yamlPreview}` : '');
            await navigator.clipboard.writeText(text);
            copyBtn.textContent = 'Copied'; setTimeout(()=> copyBtn.textContent='Copy', 1200);
          }catch{}
        };
      }
    };
    let lastValidated = null;
    modal.querySelector('#ed_run_test').onclick = async ()=>{
      // Ensure we have a parsed model; validate current tab first
      const activeIsYaml = paneYaml.style.display !== 'none';
      const rawText = (yamlEditor? yamlEditor.getValue() : rawEl.value);
      quickRunBox.innerHTML = '<em style="opacity:.8">Running…</em>';
      const vres = await fetch('/api/editor/validate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(activeIsYaml ? { raw: rawText } : { parsed: working })});
      if (!vres.ok){ alert('Validation failed to run'); return; }
      const v = await vres.json();
      renderIssues(v.issues||[], v.yaml||'');
      const valBox = modal.querySelector('#ed_validation_box'); if (valBox) valBox.open = true;
      if (!v.parsed){ alert('Cannot run: content did not parse'); return; }
      // Run the currently selected test without saving; include current env overrides from the main page
      const env = (function(){
        const env = {}; const lines = (document.getElementById('env_kv').value||'').split(/\n/);
        for (const line of lines){ const s=line.trim(); if (!s) return; const eq=s.indexOf('='); if (eq>0){ env[s.slice(0,eq).trim()] = s.slice(eq+1).trim(); } } return env;
      })();
  const body = { parsed: v.parsed, testIndex: selIndex, env, runAll: false, includeDeps: true };
  const res = await fetch('/api/editor/testrun', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
      if (!res.ok){ const t=await res.text().catch(()=> ''); alert('Run failed: '+t); return; }
      const r = await res.json();
      if (activeIsYaml){
        lastSuiteRun = r;
        // Show suite run summary in quick run box
        setQuickRunBox(r);
        try{ localStorage.setItem(`hydreq.${LS_VER}.yamlRun:`+LS_ENC(path), JSON.stringify(r)); }catch{}
        // Update per-test badges from cases
        if (Array.isArray(r.cases)){
          for (const c of r.cases){
            const idx = (working.tests||[]).findIndex(tt=> tt.name===c.name);
            if (idx>=0){ const k = idx+':'+(c.name||('test '+(idx+1))); testRunCache.set(k, c); } }
          try{ localStorage.setItem(LS_KEY(path), JSON.stringify(Object.fromEntries(testRunCache.entries()))); }catch{}
          renderTests();
        }
      } else {
        // Cache per-test result by key and render it
        const k = cacheKey();
        testRunCache.set(k, r);
        // Persist
        const obj = Object.fromEntries(testRunCache.entries());
        try{ localStorage.setItem(LS_KEY(path), JSON.stringify(obj)); }catch{}
        renderQuickRunForSelection();
        renderTests();
      }
      const qrBox = modal.querySelector('#ed_quickrun_box'); if (qrBox) qrBox.open = true;
    };
    modal.querySelector('#ed_validate').onclick = async ()=>{
      // decide whether to validate visual or YAML tab
      const activeIsYaml = paneYaml.style.display !== 'none';
  const payload = activeIsYaml ? { raw: (yamlEditor? yamlEditor.getValue() : rawEl.value) } : { parsed: working };
      issuesEl.innerHTML = '<em style="opacity:.8">Validating…</em>';
      const res = await fetch('/api/editor/validate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if (!res.ok){ alert('Validation failed to run'); return; }
      const v = await res.json();
      lastValidated = v;
  renderIssues(v.issues||[], v.yaml||'');
      const valBox = modal.querySelector('#ed_validation_box'); if (valBox) valBox.open = true;
  if (activeIsYaml){ try{ localStorage.setItem(`hydreq.${LS_VER}.yamlVal:`+LS_ENC(path), JSON.stringify(v)); }catch{} }
    };
  modal.querySelector('#ed_save').onclick = async ()=>{
      // Ensure shared YAML is up-to-date: if Visual active, serialize working; if YAML active, refresh inMemoryYaml
      const activeIsYaml = paneYaml.style.display !== 'none';
      if (!activeIsYaml) {
        await serializeWorkingToYamlImmediate();
      } else {
        inMemoryYaml = (yamlEditor ? yamlEditor.getValue() : rawEl.value);
      }
      // Validate shared YAML
      const vres = await fetch('/api/editor/validate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ raw: inMemoryYaml })});
      const v = await vres.json();
      renderIssues(v.issues||[], v.yaml||'');
      if (!v.ok){ if (!confirm('Validation reported issues. Save anyway?')) return; }
      const payload = { path, raw: inMemoryYaml };
  const saveRes = await fetch('/api/editor/save', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  if (!saveRes.ok){ const t=await saveRes.text(); alert('Save failed: '+t); return; }
  await saveRes.json();
  alert('Saved');
  dirty = false;
  try{ const di = modal && modal.querySelector && modal.querySelector('#ed_dirty_indicator'); if (di) di.style.display = 'none'; }catch{}
    // Refresh suite list so newly created suites show up immediately
    try { refresh(); } catch (e) { /* ignore */ }
    };
    modal.querySelector('#ed_save_close').onclick = async ()=>{
      await modal.querySelector('#ed_save').onclick(new Event('click'));
      if (!dirty) { modal.remove(); try { refresh(); } catch (e){} }
    };
    modal.querySelector('#ed_close').onclick = ()=> attemptClose();
  // Keep theme of CodeMirror in sync with current theme
  function syncEditorTheme(){ if (yamlEditor){ yamlEditor.setOption('theme', isDocDark() ? 'material-darker' : 'default'); yamlEditor.refresh(); } }
  // Respect last used tab; default to YAML to allow fixing malformed files
  const lastTab = (function(){ try{ return localStorage.getItem('hydreq.editor.tab') }catch{ return null } })() || 'yaml';
  // If YAML currently invalid, force YAML tab
  switchTab(lastTab === 'visual' ? 'visual' : 'yaml');
    // Show cached quick run for initial selection (if any)
    if (working.tests && working.tests.length) { try{ renderQuickRunForSelection(); }catch{} }
  }
  document.getElementById('clearLog').onclick = ()=>{ results.textContent=''; };
  document.getElementById('downloadRunJSON').onclick = ()=> downloadRun('json');
  document.getElementById('downloadRunJUnit').onclick = ()=> downloadRun('junit');
  document.getElementById('downloadRunHTML').onclick = ()=> downloadRun('html');
  // Download helpers
  async function downloadURL(url) {
    try {
      const res = await fetch(url);
      if (!res.ok) {
        const txt = await res.text().catch(()=>res.statusText);
        alert('Download failed: ' + res.status + ' - ' + txt);
        return;
      }
      const blob = await res.blob();
      const cd = res.headers.get('Content-Disposition') || '';
      let filename = 'report';
      const m = cd.match(/filename\*?=(?:UTF-8''")?"?([^;"\n]+)/i);
      if (m && m[1]) filename = decodeURIComponent(m[1]);
      const a = document.createElement('a');
      const urlObj = URL.createObjectURL(blob);
      a.href = urlObj;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(urlObj);
    } catch (e) {
      alert('Download error: ' + e.message);
    }
  }

  function downloadSuite(path, format) {
    const runId = currentRunId || lastRunId;
    if (!runId) { alert('No run available to download from. Start a run first.'); return; }
    const url = '/api/report/suite?runId=' + encodeURIComponent(runId) + '&path=' + encodeURIComponent(path) + '&format=' + encodeURIComponent(format);
    downloadURL(url);
  }

  function downloadRun(format) {
    const runId = currentRunId || lastRunId;
    if (!runId) { alert('No run available to download from. Start a run first.'); return; }
    const url = '/api/report/run?runId=' + encodeURIComponent(runId) + '&format=' + encodeURIComponent(format);
    downloadURL(url);
  }
  // init theme from localStorage (handled in initTheme via applyTheme)
  const ofInit = localStorage.getItem('hydreq.onlyFailed') === '1';
  if (ofInit) { onlyFailed.checked = true; }
  onlyFailed.onchange = ()=>{ localStorage.setItem('hydreq.onlyFailed', onlyFailed.checked ? '1' : '0'); };
  const asInit = localStorage.getItem('hydreq.autoScroll') !== '0'; // default on
  autoScroll.checked = asInit;
  autoScroll.onchange = ()=>{ localStorage.setItem('hydreq.autoScroll', autoScroll.checked ? '1' : '0'); };
  // cancel current run
  cancelBtn.onclick = async ()=>{ if (!currentRunId) return; try{ await fetch('/api/cancel?runId='+encodeURIComponent(currentRunId), { method:'POST' }); } catch(e){} };
  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    const tag = (e.target && (e.target.tagName||'')).toLowerCase();
    if (tag === 'input' || tag === 'textarea' || (e.target && e.target.isContentEditable)) return;
    if (e.key === 'r') { run(); e.preventDefault(); }
    if (e.key === 's') { cancelBtn.click(); e.preventDefault(); }
    if (e.key === 'c') { document.getElementById('clearLog').click(); e.preventDefault(); }
    if (e.key === 'f') { onlyFailed.checked = !onlyFailed.checked; onlyFailed.dispatchEvent(new Event('change')); e.preventDefault(); }
  if (e.key === 'd') { const cur = (localStorage.getItem('hydreq.theme')||'dark'); const next = (cur==='dark')?'light':'dark'; if (themeSelect){ themeSelect.value = next; } applyTheme(next); e.preventDefault(); }
  });
  refresh();
  </script>
</body>
</html>
